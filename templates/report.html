<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BLDGBIT · Property Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/comp.css') }}">
  <style>
    /* Report-specific styles - Compact & Scannable */
    .report-shell {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 16px 60px;
    }
    
    .report-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    
    .report-section {
      padding: 16px 20px;
      border-bottom: 1px solid #f5f5f5;
    }
    
    .report-section:last-child {
      border-bottom: none;
    }
    
    .report-section-header {
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: #111;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 2px solid #111;
      display: inline-block;
    }
    
    /* Property Snapshot - Top of report */
    .property-header {
      padding: 20px;
      background: linear-gradient(135deg, #111 0%, #333 100%);
      color: #fff;
    }
    
    .property-address {
      font-size: 20px;
      font-weight: 800;
      color: #fff;
      letter-spacing: -0.3px;
      margin-bottom: 6px;
    }
    
    .property-specs {
      font-size: 13px;
      color: rgba(255,255,255,0.85);
      margin-bottom: 6px;
    }
    
    .property-status {
      font-size: 12px;
      color: rgba(255,255,255,0.75);
    }
    
    .property-status strong {
      color: #fff;
      font-weight: 700;
    }
    
    /* Metrics Table - Compact 2-column grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px 16px;
    }
    
    .metric-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .metric-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #888;
    }
    
    .metric-value {
      font-size: 14px;
      font-weight: 700;
      color: #111;
    }
    
    .metric-value.success {
      color: #059669;
    }
    
    .metric-value.muted {
      color: #999;
      font-weight: 400;
      font-style: italic;
      font-size: 12px;
    }
    
    /* Full-width metric items */
    .metric-item.full-width {
      grid-column: 1 / -1;
    }
    
    /* Timeline Table - Compact */
    .timeline-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    
    .timeline-table th {
      text-align: left;
      padding: 8px 6px;
      background: #f8f8f8;
      color: #666;
      font-weight: 700;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .timeline-table td {
      padding: 8px 6px;
      border-bottom: 1px solid #f5f5f5;
      color: #333;
    }
    
    .timeline-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .timeline-total {
      margin-top: 12px;
      font-size: 13px;
      font-weight: 700;
      color: #111;
      padding: 10px;
      background: #f8f8f8;
      border-radius: 4px;
    }
    
    /* Cost Model Table - Clean & Compact */
    .cost-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .cost-table tr {
      border-bottom: 1px solid #f5f5f5;
    }
    
    .cost-table tr.subtotal {
      background: #fafafa;
      font-weight: 600;
    }
    
    .cost-table tr.total {
      background: #f5f5f5;
      font-weight: 700;
    }
    
    .cost-table td {
      padding: 8px 0;
    }
    
    .cost-table td:first-child {
      color: #666;
    }
    
    .cost-table td:last-child {
      text-align: right;
      color: #111;
      font-weight: 600;
    }
    
    .cost-table .profit-positive {
      color: #059669;
      font-weight: 700;
    }
    
    .cost-table .profit-negative {
      color: #dc2626;
      font-weight: 700;
    }
    
    /* Permit List - Compact Cards */
    .permit-item {
      background: #fafafa;
      border: 1px solid #e8e8e8;
      border-radius: 4px;
      padding: 10px 12px;
      margin-bottom: 8px;
      font-size: 11px;
    }
    
    .permit-item:last-child {
      margin-bottom: 0;
    }
    
    .permit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .permit-type {
      font-size: 11px;
      font-weight: 700;
      color: #111;
    }
    
    .permit-number {
      font-size: 9px;
      font-family: 'Monaco', 'Courier New', monospace;
      color: #666;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    .permit-desc {
      font-size: 10px;
      color: #666;
      line-height: 1.4;
    }
    
    /* Team Section - Compact */
    .team-row {
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    
    .team-row:last-child {
      border-bottom: none;
    }
    
    .team-role {
      font-size: 9px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #888;
      margin-bottom: 3px;
    }
    
    .team-name {
      font-size: 13px;
      font-weight: 700;
      color: #111;
    }
    
    .team-license {
      font-size: 10px;
      color: #666;
      font-family: 'Monaco', 'Courier New', monospace;
      margin-left: 8px;
    }
    
    .team-link {
      font-size: 10px;
      color: #111;
      text-decoration: none;
      margin-left: 10px;
      border-bottom: 1px solid #ccc;
    }
    
    .team-link:hover {
      border-bottom-color: #111;
    }
    
    /* Data Notes - Clean list */
    .data-notes-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .data-notes-list li {
      padding: 6px 0 6px 16px;
      position: relative;
      font-size: 11px;
      color: #666;
      line-height: 1.5;
      border-bottom: 1px solid #f8f8f8;
    }
    
    .data-notes-list li:before {
      content: "•";
      position: absolute;
      left: 0;
      color: #ccc;
      font-weight: 700;
    }
    
    .data-notes-list li:last-child {
      border-bottom: none;
    }
    
    .no-notes {
      font-size: 11px;
      color: #999;
      font-style: italic;
    }
    
    /* Links Section - Clean with proper hyperlinks */
    .links-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .link-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 11px;
    }
    
    .link-label {
      font-weight: 700;
      color: #888;
      min-width: 90px;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 9px;
      padding-top: 2px;
    }
    
    .link-url {
      color: #111;
      text-decoration: none;
      word-break: break-all;
      border-bottom: 1px solid #ddd;
      flex: 1;
    }
    
    .link-url:hover {
      border-bottom-color: #111;
      background: #fafafa;
    }
    
    /* Scope Badge */
    .scope-indicator {
      display: inline-block;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 12px;
      letter-spacing: 0.5px;
    }
    
    .scope-light {
      background: #ecfdf5;
      color: #065f46;
    }
    
    .scope-medium {
      background: #fffbeb;
      color: #92400e;
    }
    
    .scope-heavy {
      background: #fef2f2;
      color: #991b1b;
    }
    
    .scope-unknown {
      background: #f5f5f5;
      color: #666;
    }
    
    /* Print styles */
    @media print {
      .report-shell {
        padding: 0;
        max-width: 100%;
      }
      
      .report-card {
        box-shadow: none;
        border: 1px solid #ddd;
        page-break-inside: avoid;
      }
      
      .report-section {
        page-break-inside: avoid;
      }
      
      a {
        text-decoration: none;
        color: #111;
      }
      
      .link-url {
        word-break: break-all;
        font-size: 9px;
      }
    }
    
    /* Responsive - Mobile */
    @media (max-width: 640px) {
      .report-shell {
        padding: 16px 12px;
      }
      
      .property-header {
        padding: 16px;
      }
      
      .property-address {
        font-size: 16px;
      }
      
      .property-specs {
        font-size: 12px;
      }
      
      .metrics-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .report-section {
        padding: 14px 16px;
      }
      
      .timeline-table {
        font-size: 10px;
      }
      
      .timeline-table th,
      .timeline-table td {
        padding: 6px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="bg-layer"></div>

  <main class="report-shell">
    {% if r %}
    {% set ps = r.property_snapshot or {} %}
    {% set m = r.metrics or {} %}
    {% set cs = r.construction_summary or {} %}
    {% set cm = r.cost_model or {} %}
    {% set ts = r.timeline_summary or {} %}
    {% set pc = r.permit_categories or {} %}
    {% set team = r.team_network or {} %}
    {% set permits = r.ladbs.permits if r.ladbs and r.ladbs.permits else [] %}
    {% set dn = r.data_notes or [] %}
    {% set links = r.links or {} %}

    <div class="report-card">
      
      <!-- 1. PROPERTY SNAPSHOT -->
      <div class="property-header">
        <div class="property-address">{{ ps.address_full or r.address or "Unknown address" }}</div>
        <div class="property-specs">
          {% if ps.beds %}{{ ps.beds|int }} bd{% endif %}
          {% if ps.baths %} / {{ ps.baths }} ba{% endif %}
          {% if ps.building_sf %} · {{ "{:,.0f}".format(ps.building_sf) }} SF{% endif %}
          {% if ps.lot_sf %} · Lot {{ "{:,.0f}".format(ps.lot_sf) }} SF{% else %} · Lot: Unknown{% endif %}
          {% if ps.property_type %} · {{ ps.property_type }}{% endif %}
          {% if ps.year_built %} · Built {{ ps.year_built }}{% endif %}
        </div>
        <div class="property-status">
          {% if ps.status == "Sold" %}
            <strong>Sold on {{ ps.status_date }}</strong>
            {% if ps.status_price %} for ${{ "{:,.0f}".format(ps.status_price) }}{% endif %}
            {% if ps.list_price_before_sale %} (List: ${{ "{:,.0f}".format(ps.list_price_before_sale) }}){% endif %}
          {% elif ps.status == "Active Listing" or ps.status == "Listed" %}
            <strong>{{ ps.status }}</strong>
            {% if ps.status_price %} · ${{ "{:,.0f}".format(ps.status_price) }}{% endif %}
            {% if ps.status_date %} on {{ ps.status_date }}{% endif %}
          {% else %}
            <strong>{{ ps.status or "Status unknown" }}</strong>
            {% if ps.status_price %} · ${{ "{:,.0f}".format(ps.status_price) }}{% endif %}
            {% if ps.status_date %} on {{ ps.status_date }}{% endif %}
          {% endif %}
          {% if ps.price_per_sf %} · ${{ "{:,.0f}".format(ps.price_per_sf) }} / SF{% endif %}
        </div>
      </div>
      
      <!-- 2. DEVELOPER SNAPSHOT -->
      <div class="report-section">
        <div class="report-section-header">Developer Snapshot</div>
        <div class="metrics-grid">
          <div class="metric-item">
            <div class="metric-label">Purchase Price</div>
            <div class="metric-value">
              {% if m.purchase_price %}${{ "{:,.0f}".format(m.purchase_price) }}{% else %}<span class="muted">Unknown</span>{% endif %}
            </div>
          </div>
          
          <div class="metric-item">
            <div class="metric-label">Exit / List Price</div>
            <div class="metric-value">
              {% if m.exit_price %}${{ "{:,.0f}".format(m.exit_price) }}{% elif m.list_price %}${{ "{:,.0f}".format(m.list_price) }}{% else %}<span class="muted">Unknown</span>{% endif %}
            </div>
          </div>
          
          {% if m.purchase_price %}
          <div class="metric-item">
            <div class="metric-label">Hold Period</div>
            <div class="metric-value">
              {% if m.hold_days %}{{ m.hold_days }} days (~{{ (m.hold_days / 30.44)|round(1) }} mo){% else %}<span class="muted">Unknown</span>{% endif %}
            </div>
          </div>
          
          <div class="metric-item">
            <div class="metric-label">Gross Spread</div>
            <div class="metric-value success">
              {% if m.spread %}${{ "{:,.0f}".format(m.spread) }}{% else %}<span class="muted">N/A</span>{% endif %}
            </div>
          </div>
          
          <div class="metric-item">
            <div class="metric-label">ROI (simple)</div>
            <div class="metric-value success">
              {% if m.roi_pct %}{{ "{:.1f}%".format(m.roi_pct) }}{% else %}<span class="muted">N/A</span>{% endif %}
            </div>
          </div>
          
          <div class="metric-item">
            <div class="metric-label">Spread / Day</div>
            <div class="metric-value success">
              {% if m.spread_per_day %}<span>${{ "{:,.0f}".format(m.spread_per_day) }}</span>{% else %}<span class="muted">N/A</span>{% endif %}
            </div>
          </div>
          {% endif %}
          
          <div class="metric-item">
            <div class="metric-label">Land SF</div>
            <div class="metric-value">{% if m.land_sf %}{{ "{:,.0f}".format(m.land_sf) }} SF{% else %}<span class="muted">Unknown</span>{% endif %}</div>
          </div>
          
          <div class="metric-item">
            <div class="metric-label">Existing SF</div>
            <div class="metric-value">{% if cs.is_new_construction %}<span class="muted">0 (New Construction)</span>{% elif cs.existing_sf %}{{ "{:,.0f}".format(cs.existing_sf) }} SF{% else %}<span class="muted">Unknown</span>{% endif %}</div>
          </div>
          
          <div class="metric-item">
            <div class="metric-label">Added SF</div>
            <div class="metric-value">{% if cs.added_sf %}+{{ "{:,.0f}".format(cs.added_sf) }} SF{% else %}0{% endif %}</div>
          </div>
          
          <div class="metric-item">
            <div class="metric-label">Final SF</div>
            <div class="metric-value">{% if cs.final_sf %}{{ "{:,.0f}".format(cs.final_sf) }} SF{% else %}<span class="muted">Unknown</span>{% endif %}</div>
          </div>
          
          <div class="metric-item">
            <div class="metric-label">FAR (before → after)</div>
            <div class="metric-value">
              {% if m.far_before %}{{ m.far_before }}{% else %}<span class="muted">N/A</span>{% endif %}
              {% if m.far_after and m.far_after != m.far_before %} → {{ m.far_after }}{% endif %}
            </div>
          </div>
          
          <div class="metric-item">
            <div class="metric-label">Scope Level</div>
            <div class="metric-value">
              <span class="scope-indicator scope-{{ (pc.scope_level or 'unknown')|lower }}">{{ pc.scope_level or "UNKNOWN" }}</span>
            </div>
          </div>
          
          {% set df = r.deal_fitness or {} %}
          {% if df.score is not none %}
          <div class="metric-item full-width">
            <div class="metric-label">Deal Fitness Score</div>
            <div class="metric-value">
              <span style="font-size:18px; font-weight:800;">{{ df.score }}/{{ df.max_score or 100 }}</span>
              <span class="scope-indicator scope-{% if df.score >= 70 %}light{% elif df.score >= 50 %}medium{% else %}heavy{% endif %}" style="margin-left:10px;">Grade: {{ df.grade or '—' }}</span>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- 3. TIMELINE SUMMARY -->
      <div class="report-section">
        <div class="report-section-header">Timeline Summary</div>
        {% if ts.stages %}
        <table class="timeline-table">
          <thead>
            <tr>
              <th>Stage</th>
              <th>Duration</th>
              <th>Dates</th>
            </tr>
          </thead>
          <tbody>
            {% for stage in ts.stages %}
            <tr>
              <td>{{ stage.name }}</td>
              <td>{{ stage.days }} days</td>
              <td>{{ stage.start_date }} → {{ stage.end_date }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if ts.total_days %}
        <div class="timeline-total">
          Total Project Time: {{ ts.total_days }} days (~{{ ts.total_months }} months)
        </div>
        {% endif %}
        {% else %}
        <p class="value-muted" style="font-size:13px;">Timeline data unavailable. Missing purchase date or permit milestones.</p>
        {% endif %}
      </div>
      
      <!-- 4. CONSTRUCTION SUMMARY -->
      <div class="report-section">
        <div class="report-section-header">Construction Summary</div>
        <table class="metrics-table">
          <tr>
            <td>Existing SF</td>
            <td>{% if cs.is_new_construction %}<span class="value-muted">0 (New Construction)</span>{% elif cs.existing_sf %}{{ "{:,.0f}".format(cs.existing_sf) }} SF{% else %}<span class="value-muted">Unknown</span>{% endif %}</td>
          </tr>
          <tr>
            <td>Added SF</td>
            <td>{% if cs.added_sf %}+{{ "{:,.0f}".format(cs.added_sf) }} SF{% else %}0{% endif %}</td>
          </tr>
          <tr>
            <td>Final SF</td>
            <td>{% if cs.final_sf %}{{ "{:,.0f}".format(cs.final_sf) }} SF{% else %}<span class="value-muted">Unknown</span>{% endif %}</td>
          </tr>
          <tr>
            <td>Lot SF</td>
            <td>{% if cs.lot_sf %}{{ "{:,.0f}".format(cs.lot_sf) }} SF{% else %}<span class="value-muted">Unknown</span>{% endif %}</td>
          </tr>
          <tr>
            <td>Scope Level</td>
            <td><span class="scope-indicator scope-{{ (cs.scope_level or 'unknown')|lower }}">{{ cs.scope_level or "UNKNOWN" }}</span></td>
          </tr>
        </table>
      </div>
      
      <!-- 5. COST MODEL -->
      <div class="report-section">
        <div class="report-section-header">Cost Model</div>
        <table class="cost-table">
          {% if cm.remodel_sf > 0 %}
          <tr>
            <td>Remodel ({{ "{:,.0f}".format(cm.remodel_sf) }} SF × $150)</td>
            <td>${{ "{:,.0f}".format(cm.cost_remodel) }}</td>
          </tr>
          {% endif %}
          {% if cm.addition_sf > 0 %}
          <tr>
            <td>Addition ({{ "{:,.0f}".format(cm.addition_sf) }} SF × $300)</td>
            <td>${{ "{:,.0f}".format(cm.cost_addition) }}</td>
          </tr>
          {% endif %}
          {% if cm.new_sf_full > 0 %}
          <tr>
            <td>New Construction ({{ "{:,.0f}".format(cm.new_sf_full) }} SF × $350)</td>
            <td>${{ "{:,.0f}".format(cm.cost_new_construction) }}</td>
          </tr>
          {% endif %}
          {% if cm.garage_sf > 0 %}
          <tr>
            <td>Garage ({{ "{:,.0f}".format(cm.garage_sf) }} SF × $200)</td>
            <td>${{ "{:,.0f}".format(cm.cost_garage) }}</td>
          </tr>
          {% endif %}
          <tr>
            <td>Landscape / Hardscape / Demo</td>
            <td>${{ "{:,.0f}".format(cm.cost_landscape) }}</td>
          </tr>
          {% if cm.has_pool %}
          <tr>
            <td>Pool</td>
            <td>${{ "{:,.0f}".format(cm.cost_pool) }}</td>
          </tr>
          {% endif %}
          <tr class="subtotal">
            <td><strong>Hard Cost Total</strong></td>
            <td><strong>${{ "{:,.0f}".format(cm.hard_cost_total) }}</strong></td>
          </tr>
          <tr>
            <td>Soft Costs (6%)</td>
            <td>${{ "{:,.0f}".format(cm.soft_costs) }}</td>
          </tr>
          <tr>
            <td>Financing Cost</td>
            <td>${{ "{:,.0f}".format(cm.financing_cost) }}</td>
          </tr>
          {% if cm.total_project_cost %}
          <tr class="total">
            <td>Total Project Cost</td>
            <td>${{ "{:,.0f}".format(cm.total_project_cost) }}</td>
          </tr>
          {% endif %}
          {% if cm.estimated_profit is not none %}
          <tr class="total">
            <td>Estimated Profit</td>
            <td class="{% if cm.estimated_profit > 0 %}profit-positive{% else %}profit-negative{% endif %}">
              ${{ "{:,.0f}".format(cm.estimated_profit) }}
            </td>
          </tr>
          {% endif %}
        </table>
      </div>
      
      <!-- 6. PERMIT OVERVIEW -->
      <div class="report-section">
        <div class="report-section-header">Permit Overview</div>
        <div style="margin-bottom:14px; font-size:11px; color:#666; padding:8px; background:#f8f8f8; border-radius:4px;">
          <strong style="color:#111;">Summary:</strong> Building ({{ pc.building_count or 0 }}) · Demo ({{ pc.demo_count or 0 }}) · MEP ({{ pc.mep_count or 0 }}) · Other ({{ pc.other_count or 0 }})
          · <span class="scope-indicator scope-{{ (pc.scope_level or 'unknown')|lower }}">{{ pc.scope_level or "UNKNOWN" }}</span>
        </div>
        
        {% if permits %}
        {% set building_permits = permits | selectattr('permit_type', 'match', '.*Bldg.*|.*Building.*') | list %}
        {% set demo_permits = permits | selectattr('permit_type', 'match', '.*Demo.*') | list %}
        {% set mep_permits = permits | selectattr('permit_type', 'match', '.*Electrical.*|.*Plumbing.*|.*Mechanical.*') | list %}
        {% set other_permits = permits | rejectattr('permit_type', 'match', '.*Bldg.*|.*Building.*|.*Demo.*|.*Electrical.*|.*Plumbing.*|.*Mechanical.*') | list %}

        {% if building_permits %}
        <div style="font-size:11px; font-weight:700; color:#666; margin:16px 0 10px; text-transform:uppercase; letter-spacing:0.5px;">Building Permits ({{ pc.building_count or building_permits | length }})</div>
        {% for p in building_permits %}
        <div class="permit-item">
          <div class="permit-header">
            <span class="permit-type">{{ p.permit_type }}</span>
            <span class="permit-number">{{ p.permit_number }}</span>
          </div>
          {% if p.Work_Description and p.Work_Description != 'N/A' %}
          <div class="permit-desc">{{ p.Work_Description }}</div>
          {% endif %}
        </div>
        {% endfor %}
        {% endif %}

        {% if demo_permits %}
        <div style="font-size:11px; font-weight:700; color:#666; margin:16px 0 10px; text-transform:uppercase; letter-spacing:0.5px;">Demolition ({{ pc.demo_count or demo_permits | length }})</div>
        {% for p in demo_permits %}
        <div class="permit-item">
          <div class="permit-header">
            <span class="permit-type">{{ p.permit_type }}</span>
            <span class="permit-number">{{ p.permit_number }}</span>
          </div>
          {% if p.Work_Description and p.Work_Description != 'N/A' %}
          <div class="permit-desc">{{ p.Work_Description }}</div>
          {% endif %}
        </div>
        {% endfor %}
        {% endif %}

        {% if mep_permits %}
        <div style="font-size:11px; font-weight:700; color:#666; margin:16px 0 10px; text-transform:uppercase; letter-spacing:0.5px;">MEP ({{ pc.mep_count or mep_permits | length }})</div>
        {% for p in mep_permits %}
        <div class="permit-item">
          <div class="permit-header">
            <span class="permit-type">{{ p.permit_type }}</span>
            <span class="permit-number">{{ p.permit_number }}</span>
          </div>
        </div>
        {% endfor %}
        {% endif %}

        {% if other_permits %}
        <div style="font-size:11px; font-weight:700; color:#666; margin:16px 0 10px; text-transform:uppercase; letter-spacing:0.5px;">Other ({{ pc.other_count or other_permits | length }})</div>
        {% for p in other_permits %}
        <div class="permit-item">
          <div class="permit-header">
            <span class="permit-type">{{ p.permit_type }}</span>
            <span class="permit-number">{{ p.permit_number }}</span>
          </div>
        </div>
        {% endfor %}
        {% endif %}
        {% else %}
        <p class="value-muted" style="font-size:13px;">No permits found for this property.</p>
        {% endif %}
      </div>
      
      <!-- 7. TEAM -->
      <div class="report-section">
        <div class="report-section-header">Team</div>
        {% if team.primary_gc %}
        <div class="team-row">
          <div class="team-role">GC</div>
          <div class="team-name">
            {{ team.primary_gc.name }}
            {% if team.primary_gc.license %}
            <span class="team-license">Lic #{{ team.primary_gc.license }}</span>
            {% endif %}
            {% if team.primary_gc.cslb_url %}
            <a href="{{ team.primary_gc.cslb_url }}" target="_blank" class="team-link">CSLB Profile →</a>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        {% if team.primary_architect %}
        <div class="team-row">
          <div class="team-role">Architect</div>
          <div class="team-name">
            {{ team.primary_architect.name }}
            {% if team.primary_architect.license %}
            <span class="team-license">#{{ team.primary_architect.license }}</span>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        {% if team.primary_engineer %}
        <div class="team-row">
          <div class="team-role">Engineer</div>
          <div class="team-name">
            {{ team.primary_engineer.name }}
            {% if team.primary_engineer.license %}
            <span class="team-license">#{{ team.primary_engineer.license }}</span>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        {% if not team.primary_gc and not team.primary_architect and not team.primary_engineer %}
        <p class="value-muted" style="font-size:13px;">No team members found in permit records.</p>
        {% endif %}
      </div>
      
      <!-- 8. STRATEGY NOTES -->
      {% set sn = r.strategy_notes or {} %}
      {% if sn.tactics or sn.risks or sn.insights %}
      <div class="report-section">
        <div class="report-section-header">Strategy Notes</div>
        
        {% if sn.tactics %}
        <div style="margin-bottom:16px;">
          <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:#888; margin-bottom:8px;">Tactics</div>
          <ul style="list-style:none; padding:0; margin:0;">
            {% for tactic in sn.tactics %}
            <li style="padding:6px 0 6px 16px; position:relative; font-size:12px; color:#333; border-bottom:1px solid #f5f5f5;">
              <span style="position:absolute; left:0; color:#059669; font-weight:700;">•</span>
              {{ tactic }}
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if sn.risks %}
        <div style="margin-bottom:16px;">
          <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:#888; margin-bottom:8px;">Risks</div>
          <ul style="list-style:none; padding:0; margin:0;">
            {% for risk in sn.risks %}
            <li style="padding:6px 0 6px 16px; position:relative; font-size:12px; color:#333; border-bottom:1px solid #f5f5f5;">
              <span style="position:absolute; left:0; color:#dc2626; font-weight:700;">!</span>
              {{ risk }}
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if sn.insights %}
        <div>
          <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:#888; margin-bottom:8px;">Insights</div>
          <ul style="list-style:none; padding:0; margin:0;">
            {% for insight in sn.insights %}
            <li style="padding:6px 0 6px 16px; position:relative; font-size:12px; color:#333; border-bottom:1px solid #f5f5f5;">
              <span style="position:absolute; left:0; color:#3b82f6; font-weight:700;">→</span>
              {{ insight }}
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if sn.source == 'fallback' %}
        <div style="margin-top:12px; font-size:10px; color:#999; font-style:italic;">
          Generated from permit data (AI unavailable)
        </div>
        {% endif %}
      </div>
      {% endif %}
      
      <!-- 9. DATA NOTES -->
      <div class="report-section">
        <div class="report-section-header">Data Notes</div>
        {% if dn %}
        <ul class="data-notes-list">
          {% for note in dn %}
          <li>{{ note }}</li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="no-notes">No major data issues detected.</p>
        {% endif %}
      </div>
      
      <!-- 9. LINKS -->
      <div class="report-section">
        <div class="report-section-header">Links</div>
        <div class="links-list">
          {% if links.redfin_url or r.redfin_url or r.url %}
          <div class="link-item">
            <span class="link-label">Redfin</span>
            <a href="{{ links.redfin_url or r.redfin_url or r.url }}" target="_blank" rel="noopener noreferrer" class="link-url">{{ links.redfin_url or r.redfin_url or r.url }}</a>
          </div>
          {% endif %}
          
          {% if links.ladbs_url or r.ladbs_url %}
          <div class="link-item">
            <span class="link-label">LADBS</span>
            <a href="{{ links.ladbs_url or r.ladbs_url }}" target="_blank" rel="noopener noreferrer" class="link-url">{{ links.ladbs_url or r.ladbs_url }}</a>
          </div>
          {% endif %}
          
          {% if team.primary_gc and team.primary_gc.cslb_url %}
          <div class="link-item">
            <span class="link-label">GC CSLB</span>
            <a href="{{ team.primary_gc.cslb_url }}" target="_blank" rel="noopener noreferrer" class="link-url">{{ team.primary_gc.cslb_url }}</a>
          </div>
          {% elif links.gc_cslb_url %}
          <div class="link-item">
            <span class="link-label">GC CSLB</span>
            <a href="{{ links.gc_cslb_url }}" target="_blank" rel="noopener noreferrer" class="link-url">{{ links.gc_cslb_url }}</a>
          </div>
          {% endif %}
        </div>
      </div>
      
    </div>
    {% else %}
    <div class="report-card">
      <div class="report-section">
        <p style="text-align:center; color:#888; padding:40px 20px;">No report data available.</p>
      </div>
    </div>
    {% endif %}

    <footer class="footer">
      <div>© {{ year or 2025 }} BLDGBIT · Internal Tool</div>
    </footer>
  </main>

</body>
</html>
