<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BLDGBIT AI · Comp Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/comp.css') }}">
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing…</div>
  </div>

  <div class="bg-layer"></div>

  <main class="shell">

    <header class="hero-card">
      <div class="logo-wrap">
        <div class="logo-plate"></div>
        <img src="{{ url_for('static', filename='LG.png') }}"
             class="logo-img" alt="BLDGBIT">
      </div>
      <div class="hero-text">
        <div class="eyebrow">BLDGBIT AI</div>
        <h1 class="hero-title">Comp Intelligence</h1>
        <p class="hero-subtitle">
          Investor-grade comp briefs backed by LADBS intelligence.
        </p>
      </div>
    </header>

    <section class="panel">
      <form method="post" action="{{ url_for('comp_intel') }}" class="comp-form" id="compForm">
        <label class="field-label" for="urls">Paste Redfin URLs</label>
        <p class="field-hint">
          One per line. Example:
          <span class="hint-url">https://www.redfin.com/...</span>
        </p>

        <div class="textarea-wrap">
          <textarea id="urls" name="urls" rows="6">{{ urls_text or "" }}</textarea>
        </div>

        <div class="form-footer">
          <div class="foot-note">LADBS Auto Search Enabled</div>
          <button type="submit" class="btn-primary">
            <span>Run Analysis</span>
            <span class="btn-tag">AI</span>
          </button>
        </div>
      </form>
    </section>

    {% if results %}
    <section class="results">

      {% for r in results %}
      {% set pc = r.project_contacts or {} %}
      {% set cslb = r.cslb_contractor or None %}
      {% set permits = r.ladbs.permits if r.ladbs and r.ladbs.permits else [] %}

      <article class="comp-card">

        <header class="comp-header">
          <div class="comp-title-block">
            <div class="comp-label">COMP</div>
            <h2 class="comp-address">{{ r.address or "Unknown address" }}</h2>
            <a href="{{ r.url }}" target="_blank" class="comp-link">{{ r.url }}</a>
          </div>

          <div class="stat-grid">
            <div class="stat-pill"><div class="stat-label">CURRENT</div>
              <div class="stat-value">{{ r.current_summary or "—" }}</div></div>
            <div class="stat-pill"><div class="stat-label">PUBLIC RECORD</div>
              <div class="stat-value">{{ r.public_record_summary or "—" }}</div></div>
            <div class="stat-pill"><div class="stat-label">LOT</div>
              <div class="stat-value">{{ r.lot_summary or "—" }}</div></div>
            <div class="stat-pill"><div class="stat-label">LADBS PERMITS</div>
              <div class="stat-value">
                {% if r.ladbs and r.ladbs.source and (r.ladbs.source.startswith('ladbs_stub_') or r.ladbs.source == 'ladbs_error') %}
                  No LADBS permit data available
                {% else %}
                  {{ r.permit_summary or "—" }}
                {% endif %}
              </div></div>
          </div>
        </header>

        <section class="comp-body">

          <!-- DEAL SNAPSHOT -->
          <div class="deal-snapshot">
            <div class="snapshot-row">
              <div class="snapshot-item">
                <span class="snapshot-label">Purchase:</span>
                <span class="snapshot-value">
                  {% if r.metrics.purchase_price %}
                    ${{ "{:,.0f}".format(r.metrics.purchase_price) }}
                    <span class="snapshot-date">{{ r.metrics.purchase_date }}</span>
                  {% else %}No purchase data{% endif %}
                </span>
              </div>
              <div class="snapshot-item">
                <span class="snapshot-label">Exit:</span>
                <span class="snapshot-value">
                  {% if r.metrics.exit_price %}
                    ${{ "{:,.0f}".format(r.metrics.exit_price) }}
                    <span class="snapshot-date">{{ r.metrics.exit_date }}</span>
                  {% else %}—{% endif %}
                </span>
              </div>
              <div class="snapshot-item">
                <span class="snapshot-label">Listing:</span>
                <span class="snapshot-value snapshot-highlight">
                  {% if r.metrics.list_price %}
                    ${{ "{:,.0f}".format(r.metrics.list_price) }}
                  {% else %}—{% endif %}
                </span>
              </div>
            </div>
            <div class="snapshot-row">
              <div class="snapshot-item">
                <span class="snapshot-label">Spread:</span>
                <span class="snapshot-value {% if r.metrics.spread %}snapshot-success{% endif %}">
                  {% if r.metrics.spread %}
                    ${{ "{:,.0f}".format(r.metrics.spread) }}
                    ({{ "{:.1f}%".format(r.metrics.roi_pct) }} ROI)
                  {% else %}—{% endif %}
                </span>
              </div>
              <div class="snapshot-item">
                <span class="snapshot-label">Hold:</span>
                <span class="snapshot-value">
                  {% if r.metrics.hold_days %}{{ r.metrics.hold_days }} days{% else %}—{% endif %}
                </span>
              </div>
              <div class="snapshot-item">
                <span class="snapshot-label">Permits:</span>
                <span class="snapshot-value">{{ permits | length }} filed</span>
              </div>
            </div>
          </div>

          <!-- WORK PERFORMED -->
          {% if permits %}
          {% set permits = r.ladbs.permits if r.ladbs is defined and r.ladbs.permits is defined and r.ladbs.permits is not none else [] %}
          <div class="section-header">
            <h3 class="section-title">Work Performed</h3>
            <span class="section-count">{{ permits | length }} permits</span>
          </div>

          {% set building_permits = permits | selectattr('permit_type', 'match', '.*Bldg.*|.*Building.*') | list %}
          {% set demo_permits = permits | selectattr('permit_type', 'match', '.*Demo.*') | list %}
          {% set mep_permits = permits | rejectattr('permit_type', 'match', '.*Bldg.*|.*Building.*|.*Demo.*') | list %}

          {% if building_permits %}
          <div class="permit-group">
            <div class="permit-group-header">Building & Structure ({{ building_permits | length }})</div>
            {% for p in building_permits %}
            <div class="permit-compact">
              <div class="permit-compact-main">
                <span class="permit-compact-type">{{ p.permit_type }}</span>
                <span class="permit-compact-number">{{ p.permit_number }}</span>
              </div>
              {% if p.Work_Description and p.Work_Description != 'N/A' %}
              <div class="permit-work-desc">{{ p.Work_Description }}</div>
              {% endif %}
              <div class="permit-compact-meta">
                <span>{{ p.Status }}</span>
                {% if p.contractor %} • Contractor: {{ p.contractor[:40] }}{% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {% if demo_permits %}
          <div class="permit-group">
            <div class="permit-group-header">Demolition ({{ demo_permits | length }})</div>
            {% for p in demo_permits %}
            <div class="permit-compact">
              <div class="permit-compact-main">
                <span class="permit-compact-type">{{ p.permit_type }}</span>
                <span class="permit-compact-number">{{ p.permit_number }}</span>
              </div>
              {% if p.Work_Description and p.Work_Description != 'N/A' %}
              <div class="permit-work-desc">{{ p.Work_Description }}</div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {% if mep_permits %}
          <div class="permit-group">
            <div class="permit-group-header">MEP & Other ({{ mep_permits | length }})</div>
            {% for p in mep_permits %}
            <div class="permit-compact">
              <div class="permit-compact-main">
                <span class="permit-compact-type">{{ p.permit_type }}</span>
                <span class="permit-compact-number">{{ p.permit_number }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% else %}
          <div class="no-data-message">
            {% if r.ladbs and r.ladbs.source and (r.ladbs.source.startswith('ladbs_stub_') or r.ladbs.source == 'ladbs_error') %}
              ⚠️ LADBS data unavailable - cannot verify permit history
            {% else %}
              No permits found for this property
            {% endif %}
          </div>
          {% endif %}

          <!-- TEAM -->
          {% set has_team = (permits | selectattr('contractor') | list) or (permits | selectattr('architect') | list) %}
          {% if has_team %}
          <div class="section-header">
            <h3 class="section-title">Team</h3>
          </div>
          
          <div class="team-grid">
            {% set contractors = permits | selectattr('contractor') | map(attribute='contractor') | unique | list %}
            {% for contractor in contractors %}
            <div class="team-card">
              <div class="team-role">Contractor</div>
              <div class="team-name">{{ contractor }}</div>
              {% set lic = permits | selectattr('contractor', 'equalto', contractor) | map(attribute='contractor_license') | select | first %}
              {% if lic %}<div class="team-license">Lic {{ lic }}</div>{% endif %}
            </div>
            {% endfor %}

            {% set architects = permits | selectattr('architect') | map(attribute='architect') | unique | list %}
            {% for architect in architects %}
            <div class="team-card">
              <div class="team-role">Architect</div>
              <div class="team-name">{{ architect }}</div>
              {% set lic = permits | selectattr('architect', 'equalto', architect) | map(attribute='architect_license') | select | first %}
              {% if lic %}<div class="team-license">Lic {{ lic }}</div>{% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}

        </section>

      </article>
      {% endfor %}
    </section>
    {% endif %}

    <footer class="footer">
      <div>© {{ year or 2025 }} BLDGBIT · Internal Tool</div>
      <div class="footer-tagline">Efficient. Transparent. Investor-exclusive.</div>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  document.getElementById("compForm").addEventListener("submit", () => {
    document.getElementById("loadingOverlay").classList.add("show");
  });

  // Hide loading overlay when page fully loads
  window.addEventListener("load", () => {
    document.getElementById("loadingOverlay").classList.remove("show");
  });

  window.addEventListener("DOMContentLoaded", () => {

    document.querySelectorAll("[data-price-history]").forEach(c => {
      const data = JSON.parse(c.dataset.priceHistory);

      new Chart(c, {
        type: "line",
        data: {
          labels: data.map(x => x.date),
          datasets: [{
            label: "Price",
            data: data.map(x => x.price),
            tension: 0.25,
            borderWidth: 2,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            pointBackgroundColor: data.map(x => 
              x.event === 'sold' ? '#ef4444' : '#3b82f6'
            ),
            pointRadius: 4
          }]
        },
        options: { 
          plugins:{legend:{display:false}},
          scales: {
            y: {
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    });

    document.querySelectorAll("[data-permit-timeline]").forEach(c => {
      const raw = JSON.parse(c.dataset.permitTimeline);
      
      // FILTER: only include permits with duration_days > 0
      const withDuration = raw.filter(x => x.duration_days && x.duration_days > 0);
      
      if (withDuration.length === 0) {
        c.style.display = 'none';  // hide chart if no data
        return;
      }
      
      const labels = withDuration.map(x => x.permit_number);
      const days = withDuration.map(x => x.duration_days);

      new Chart(c, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label:"Duration (days)",
            data:days,
            backgroundColor: '#3b82f6',
            borderWidth:1
          }]
        },
        options: { 
          indexAxis: 'y', 
          plugins:{legend:{display:false}},
          scales: {
            x: {
              title: { display: true, text: 'Days' }
            }
          }
        }
      });
    });
  });
  </script>

</body>
</html>
