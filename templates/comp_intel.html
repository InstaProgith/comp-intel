<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BLDGBIT AI · Comp Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/comp.css') }}">
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing…</div>
  </div>

  <div class="bg-layer"></div>

  <!-- Floating Summary Bar -->
  <div class="floating-summary" id="floatingSummary">
    <div class="floating-summary-content">
      <span id="floatingSummaryText"></span>
    </div>
  </div>

  <main class="shell">

    <header class="hero-card">
      <div class="hero-top">
        <div class="logo-wrap">
          <img src="{{ url_for('static', filename='LG.png') }}"
               class="logo-img" alt="BLDGBIT">
        </div>
        <div class="hero-text">
          <div class="eyebrow">BLDGBIT AI</div>
          <h1 class="hero-title">Comp Intelligence</h1>
          <p class="hero-subtitle">
            Investor-grade property intelligence powered by BLDGBIT AI and enhanced with LADBS permit analytics.
          </p>
          <p class="hero-subtitle-secondary">
            Instant comp briefs. Verified data sources. Developer-level clarity.
          </p>
        </div>
      </div>
      <div class="hero-divider"></div>
    </header>

    <section class="panel">
      <form method="post" action="{{ url_for('comp_intel') }}" class="comp-form" id="compForm">
        <label class="field-label" for="urls">Paste Redfin URLs</label>
        <p class="field-hint">
          One per line. Examples:<br>
          <span class="hint-url">https://www.redfin.com/CA/Los-Angeles/123-Main-St-90012/home/12345678</span><br>
          <span class="hint-url">https://www.redfin.com/CA/Beverly-Hills/456-Palm-Dr-90210/home/87654321</span>
        </p>

        <div class="textarea-wrap">
          <textarea id="urls" name="urls" rows="6" placeholder="Paste Redfin property URLs here...

Example:
https://www.redfin.com/CA/Los-Angeles/123-Main-St-90012/home/12345678">{{ urls_text or "" }}</textarea>
        </div>

        <p class="field-note">Each URL is validated, scraped, and cross-linked with LADBS records.</p>

        <div class="form-footer">
          <div class="foot-note">LADBS Auto Search Enabled</div>
          <button type="submit" class="btn-primary">
            <span>Run Analysis</span>
            <span class="btn-tag">AI</span>
          </button>
        </div>

        <div class="progress-bar" id="progressBar">
          <div class="progress-bar-inner"></div>
        </div>
      </form>
    </section>

    {% if results %}
    <section class="results">

      {% for r in results %}
      {% set pc = r.project_contacts or {} %}
      {% set cslb = r.cslb_contractor or None %}
      {% set permits = r.ladbs.permits if r.ladbs and r.ladbs.permits else [] %}
      {% set redfin = r.redfin or {} %}

      <article class="comp-card" data-address="{{ r.address or '' }}" data-summary="{{ r.current_summary or '' }}">

        <header class="comp-header">
          <div class="comp-title-block">
            <div class="comp-label">COMP</div>
            <h2 class="comp-address">{{ r.address or "Unknown address" }}</h2>
            <a href="{{ r.url }}" target="_blank" rel="noopener" class="comp-link">{{ r.url }}</a>
          </div>

          <div class="stat-grid">
            <div class="stat-pill"><div class="stat-label">CURRENT</div>
              <div class="stat-value">{{ r.current_summary or "—" }}</div></div>
            <div class="stat-pill"><div class="stat-label">PUBLIC RECORD</div>
              <div class="stat-value">{{ r.public_record_summary or "—" }}</div></div>
            <div class="stat-pill"><div class="stat-label">LOT</div>
              <div class="stat-value">{{ r.lot_summary or "—" }}</div></div>
            <div class="stat-pill"><div class="stat-label">LADBS PERMITS</div>
              <div class="stat-value">
                {% if r.ladbs and r.ladbs.source and (r.ladbs.source.startswith('ladbs_stub_') or r.ladbs.source == 'ladbs_error') %}
                  No LADBS permit data available
                {% else %}
                  {{ r.permit_summary or "—" }}
                {% endif %}
              </div></div>
          </div>
        </header>

        <section class="comp-body">

          <!-- DEVELOPER SNAPSHOT -->
          <div class="developer-snapshot">
            <div class="developer-snapshot-title">Developer Snapshot</div>
            
            {% set land_sf = redfin.get('lot_sf') or redfin.get('lot_size_sf') or (redfin.get('public_records') or {}).get('lot_sf') %}
            {% set building_sf = redfin.get('building_sf') or redfin.get('listing_building_sf') or (redfin.get('public_records') or {}).get('building_sf') %}
            {% set list_price = r.metrics.list_price or redfin.get('list_price') %}
            {% set unit_count = redfin.get('units') or redfin.get('unit_count') %}
            {% set year_built = redfin.get('year_built') or (redfin.get('public_records') or {}).get('year_built') %}
            
            <div class="developer-grid">
              <div class="developer-metric">
                <span class="developer-metric-label">Land SF</span>
                <span class="developer-metric-value highlight">
                  {% if land_sf %}{{ "{:,.0f}".format(land_sf) }} SF{% else %}Data not available{% endif %}
                </span>
                <span class="developer-metric-note">Land area</span>
              </div>
              
              <div class="developer-metric">
                <span class="developer-metric-label">Building SF</span>
                <span class="developer-metric-value">
                  {% if building_sf %}{{ "{:,.0f}".format(building_sf) }} SF{% else %}Data not available{% endif %}
                </span>
              </div>
              
              <div class="developer-metric">
                <span class="developer-metric-label">FAR (Existing)</span>
                <span class="developer-metric-value highlight">
                  {% if building_sf and land_sf and land_sf > 0 %}
                    {{ "%.2f"|format(building_sf / land_sf) }}
                  {% else %}
                    Data not available
                  {% endif %}
                </span>
                <span class="developer-metric-note">Building SF / Land SF</span>
              </div>
              
              <div class="developer-metric">
                <span class="developer-metric-label">Units</span>
                <span class="developer-metric-value">
                  {% if unit_count %}{{ unit_count }}{% else %}Data not available{% endif %}
                </span>
              </div>
              
              <div class="developer-metric">
                <span class="developer-metric-label">Price per Building SF</span>
                <span class="developer-metric-value">
                  {% if list_price and building_sf and building_sf > 0 %}
                    ${{ "{:,.0f}".format(list_price / building_sf) }}/SF
                  {% else %}
                    Data not available
                  {% endif %}
                </span>
              </div>
              
              <div class="developer-metric">
                <span class="developer-metric-label">Price per Land SF</span>
                <span class="developer-metric-value">
                  {% if list_price and land_sf and land_sf > 0 %}
                    ${{ "{:,.0f}".format(list_price / land_sf) }}/SF
                  {% else %}
                    Data not available
                  {% endif %}
                </span>
              </div>
              
              <div class="developer-metric">
                <span class="developer-metric-label">Price per Unit</span>
                <span class="developer-metric-value">
                  {% if list_price and unit_count and unit_count > 0 %}
                    ${{ "{:,.0f}".format(list_price / unit_count) }}/unit
                  {% else %}
                    Data not available
                  {% endif %}
                </span>
              </div>
              
              <div class="developer-metric">
                <span class="developer-metric-label">Year Built</span>
                <span class="developer-metric-value">
                  {% if year_built %}{{ year_built }}{% else %}Data not available{% endif %}
                </span>
              </div>
            </div>
            
            <!-- Data Completeness Indicator -->
            {% set metrics_available = 0 %}
            {% if land_sf %}{% set metrics_available = metrics_available + 1 %}{% endif %}
            {% if building_sf %}{% set metrics_available = metrics_available + 1 %}{% endif %}
            {% if list_price %}{% set metrics_available = metrics_available + 1 %}{% endif %}
            {% if unit_count %}{% set metrics_available = metrics_available + 1 %}{% endif %}
            {% if year_built %}{% set metrics_available = metrics_available + 1 %}{% endif %}
            
            <div class="data-completeness {% if metrics_available >= 4 %}high{% elif metrics_available >= 2 %}moderate{% else %}limited{% endif %}">
              {% if metrics_available >= 4 %}
                Data completeness: High – most core metrics available.
              {% elif metrics_available >= 2 %}
                Data completeness: Moderate – some core metrics missing.
              {% else %}
                Data completeness: Limited – important metrics not available from sources.
              {% endif %}
            </div>
          </div>

          <!-- PROJECT SNAPSHOT -->
          <div class="deal-snapshot">
            <div class="section-header" style="margin-top: 0;">
              <h3 class="section-title">Project Snapshot</h3>
            </div>
            
            <!-- Purchase Info -->
            <div class="snapshot-row">
              <div class="snapshot-item-wide">
                <span class="snapshot-label">Purchased:</span>
                <span class="snapshot-value">
                  {% if r.metrics.purchase_date and r.metrics.purchase_price %}
                    <strong>{{ r.metrics.purchase_date }}</strong> for <strong>${{ "{:,.0f}".format(r.metrics.purchase_price) }}</strong>
                  {% else %}
                    <span class="muted">Data not available</span>
                  {% endif %}
                </span>
              </div>
            </div>
            
            <!-- Size Change -->
            {% if r.metrics.original_sf or r.metrics.new_sf %}
            <div class="snapshot-row">
              <div class="snapshot-item-wide">
                <span class="snapshot-label">Size change:</span>
                <span class="snapshot-value">
                  {% if r.metrics.original_sf %}{{ "{:,.0f}".format(r.metrics.original_sf) }} SF{% else %}—{% endif %}
                  →
                  {% if r.metrics.new_sf %}{{ "{:,.0f}".format(r.metrics.new_sf) }} SF{% else %}—{% endif %}
                  {% if r.metrics.sf_added %}
                    <span class="snapshot-success">(+{{ "{:,.0f}".format(r.metrics.sf_added) }} SF / +{{ "{:.0f}%".format(r.metrics.sf_pct_change) }})</span>
                  {% endif %}
                </span>
              </div>
            </div>
            {% endif %}
            
            <!-- Permit Timeline -->
            {% if r.permit_timeline %}
            {% set pt = r.permit_timeline %}
            {% if pt.plans_submitted_date %}
            <div class="snapshot-row">
              <div class="snapshot-item-wide">
                <span class="snapshot-label">Plans submitted:</span>
                <span class="snapshot-value">
                  <strong>{{ pt.plans_submitted_date }}</strong>
                  {% if r.project_durations and r.project_durations.days_to_submit %}
                    <span class="muted">({{ r.project_durations.days_to_submit }} days after purchase)</span>
                  {% endif %}
                </span>
              </div>
            </div>
            {% endif %}
            
            {% if pt.plans_approved_date %}
            <div class="snapshot-row">
              <div class="snapshot-item-wide">
                <span class="snapshot-label">Plans approved:</span>
                <span class="snapshot-value">
                  <strong>{{ pt.plans_approved_date }}</strong>
                  {% if r.project_durations and r.project_durations.days_to_approve %}
                    <span class="muted">({{ r.project_durations.days_to_approve }} days after submission)</span>
                  {% endif %}
                </span>
              </div>
            </div>
            {% endif %}
            
            {% if pt.construction_completed_date %}
            <div class="snapshot-row">
              <div class="snapshot-item-wide">
                <span class="snapshot-label">Construction completed:</span>
                <span class="snapshot-value">
                  <strong>{{ pt.construction_completed_date }}</strong>
                  {% if r.project_durations and r.project_durations.days_to_complete %}
                    <span class="muted">({{ r.project_durations.days_to_complete }} days after approval)</span>
                  {% endif %}
                </span>
              </div>
            </div>
            {% endif %}
            
            {% if r.project_durations and r.project_durations.total_project_days %}
            <div class="snapshot-row">
              <div class="snapshot-item-wide">
                <span class="snapshot-label">Total project time:</span>
                <span class="snapshot-value snapshot-success">
                  <strong>{{ r.project_durations.total_project_days }} days</strong> (purchase → completion)
                </span>
              </div>
            </div>
            {% endif %}
            {% endif %}
          </div>
          
          <!-- TEAM -->
          <div class="deal-snapshot">
            <div class="section-header" style="margin-top: 0;">
              <h3 class="section-title">Team</h3>
            </div>
            
            {% set permits_list = r.ladbs.permits if r.ladbs is defined and r.ladbs.permits is defined and r.ladbs.permits is not none else [] %}
            {% set contractors = [] %}
            {% set architects = [] %}
            {% set engineers = [] %}
            {% set contractor_licenses = {} %}
            {% set architect_licenses = {} %}
            {% set engineer_licenses = {} %}
            
            {% for p in permits_list %}
              {% if p.contractor and p.contractor not in contractors %}
                {% set _ = contractors.append(p.contractor) %}
                {% if p.contractor_license %}
                  {% set _ = contractor_licenses.update({p.contractor: p.contractor_license}) %}
                {% endif %}
              {% endif %}
              {% if p.architect and p.architect not in architects %}
                {% set _ = architects.append(p.architect) %}
                {% if p.architect_license %}
                  {% set _ = architect_licenses.update({p.architect: p.architect_license}) %}
                {% endif %}
              {% endif %}
              {% if p.engineer and p.engineer not in engineers %}
                {% set _ = engineers.append(p.engineer) %}
                {% if p.engineer_license %}
                  {% set _ = engineer_licenses.update({p.engineer: p.engineer_license}) %}
                {% endif %}
              {% endif %}
            {% endfor %}
            
            <div class="team-grid">
              <div class="team-card">
                <div class="team-role">Contractor</div>
                <div class="team-name">
                  {% if contractors %}
                    {{ contractors[0] }}
                    {% if 'OWNER' in contractors[0].upper() %}<span class="muted"> (owner-builder)</span>{% endif %}
                  {% else %}
                    <span class="muted">None on record</span>
                  {% endif %}
                </div>
                {% if contractors and contractor_licenses.get(contractors[0]) %}
                <div class="team-license">
                  <a href="https://www.cslb.ca.gov/OnlineServices/CheckLicenseII/CheckLicense.aspx?licensenumber={{ contractor_licenses.get(contractors[0]) }}" target="_blank" rel="noopener">
                    Lic {{ contractor_licenses.get(contractors[0]) }}
                  </a>
                </div>
                {% endif %}
              </div>
              
              <div class="team-card">
                <div class="team-role">Architect</div>
                <div class="team-name">
                  {% if architects %}{{ architects[0] }}{% else %}<span class="muted">None on record</span>{% endif %}
                </div>
                {% if architects and architect_licenses.get(architects[0]) %}
                <div class="team-license">Lic {{ architect_licenses.get(architects[0]) }}</div>
                {% endif %}
              </div>
              
              <div class="team-card">
                <div class="team-role">Engineer</div>
                <div class="team-name">
                  {% if engineers %}{{ engineers[0] }}{% else %}<span class="muted">None on record</span>{% endif %}
                </div>
                {% if engineers and engineer_licenses.get(engineers[0]) %}
                <div class="team-license">Lic {{ engineer_licenses.get(engineers[0]) }}</div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- DEAL METRICS -->
          <div class="deal-snapshot">
            <div class="section-header" style="margin-top: 0;">
              <h3 class="section-title">Deal Metrics</h3>
            </div>
            
            <div class="metrics-grid">
              <div class="metrics-grid-item">
                <span class="snapshot-label">Purchase price</span>
                <div class="snapshot-value">
                  {% if r.metrics.purchase_price %}${{ "{:,.0f}".format(r.metrics.purchase_price) }}{% else %}Data not available{% endif %}
                </div>
              </div>
              <div class="metrics-grid-item">
                <span class="snapshot-label">Exit/List price</span>
                <div class="snapshot-value">
                  {% if r.metrics.exit_price %}
                    ${{ "{:,.0f}".format(r.metrics.exit_price) }}
                  {% elif r.metrics.list_price %}
                    ${{ "{:,.0f}".format(r.metrics.list_price) }} <span class="muted">(current listing)</span>
                  {% else %}Data not available{% endif %}
                </div>
              </div>
              <div class="metrics-grid-item">
                <span class="snapshot-label">Gross spread</span>
                <div class="snapshot-value {% if r.metrics.spread %}snapshot-success{% endif %}">
                  {% if r.metrics.spread %}${{ "{:,.0f}".format(r.metrics.spread) }}{% else %}Data not available{% endif %}
                </div>
              </div>
              <div class="metrics-grid-item">
                <span class="snapshot-label">ROI</span>
                <div class="snapshot-value {% if r.metrics.roi_pct %}snapshot-success{% endif %}">
                  {% if r.metrics.roi_pct %}{{ "{:.1f}%".format(r.metrics.roi_pct) }}{% else %}Data not available{% endif %}
                </div>
              </div>
              <div class="metrics-grid-item">
                <span class="snapshot-label">Hold period</span>
                <div class="snapshot-value">
                  {% if r.metrics.hold_days %}{{ r.metrics.hold_days }} days{% else %}Data not available{% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- WORK PERFORMED -->
          {% if permits %}
          {% set permits_list = r.ladbs.permits if r.ladbs is defined and r.ladbs.permits is defined and r.ladbs.permits is not none else [] %}
          
          <!-- Permit Summary Chart -->
          {% set building_permits = permits_list | selectattr('permit_type', 'match', '.*Bldg.*|.*Building.*') | list %}
          {% set demo_permits = permits_list | selectattr('permit_type', 'match', '.*Demo.*') | list %}
          {% set mep_permits = permits_list | rejectattr('permit_type', 'match', '.*Bldg.*|.*Building.*|.*Demo.*') | list %}
          
          <div class="permit-chart-container">
            <div class="permit-chart-title">Permit Summary</div>
            <canvas id="permitChart{{ loop.index }}" class="permit-chart" 
                    data-building="{{ building_permits | length }}" 
                    data-demo="{{ demo_permits | length }}" 
                    data-mep="{{ mep_permits | length }}"></canvas>
            <a href="#permit-details-{{ loop.index }}" class="view-full-history">View full permit history ↓</a>
          </div>
          
          <div class="section-header" id="permit-details-{{ loop.index }}">
            <h3 class="section-title">Work Performed</h3>
            <span class="section-count">{{ permits_list | length }} permits</span>
          </div>

          {% if building_permits %}
          <div class="permit-group">
            <div class="permit-group-header">Building & Structure ({{ building_permits | length }})</div>
            {% for p in building_permits %}
            <div class="permit-compact">
              <div class="permit-compact-main">
                <span class="permit-compact-type">{{ p.permit_type }}</span>
                <span class="permit-compact-number">
                  {% if p.permit_number %}
                  <a href="https://ladbsdoc.lacity.org/IDISPublic_v2/idis/permitstatus.aspx?permit={{ p.permit_number|replace('/', '') }}" target="_blank" rel="noopener">
                    {{ p.permit_number }}
                  </a>
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>
              {% if p.Work_Description and p.Work_Description != 'N/A' %}
              <div class="permit-work-desc">{{ p.Work_Description }}</div>
              {% endif %}
              <div class="permit-compact-meta">
                <span>{{ p.Status }}</span>
                {% if p.contractor %} • Contractor: {{ p.contractor[:40] }}{% endif %}
              </div>
              {% if p.Status %}
              <div class="permit-status {% if 'FINAL' in p.Status.upper() or 'COMPLETE' in p.Status.upper() %}completed{% elif 'ISSUED' in p.Status.upper() or 'PENDING' in p.Status.upper() %}pending{% elif 'EXPIRED' in p.Status.upper() %}expired{% endif %}">
                Permit Status: {{ p.Status }}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {% if demo_permits %}
          <div class="permit-group">
            <div class="permit-group-header">Demolition ({{ demo_permits | length }})</div>
            {% for p in demo_permits %}
            <div class="permit-compact demo">
              <div class="permit-compact-main">
                <span class="permit-compact-type">{{ p.permit_type }}</span>
                <span class="permit-compact-number">
                  {% if p.permit_number %}
                  <a href="https://ladbsdoc.lacity.org/IDISPublic_v2/idis/permitstatus.aspx?permit={{ p.permit_number|replace('/', '') }}" target="_blank" rel="noopener">
                    {{ p.permit_number }}
                  </a>
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>
              {% if p.Work_Description and p.Work_Description != 'N/A' %}
              <div class="permit-work-desc">{{ p.Work_Description }}</div>
              {% endif %}
              {% if p.Status %}
              <div class="permit-status {% if 'FINAL' in p.Status.upper() or 'COMPLETE' in p.Status.upper() %}completed{% elif 'ISSUED' in p.Status.upper() or 'PENDING' in p.Status.upper() %}pending{% elif 'EXPIRED' in p.Status.upper() %}expired{% endif %}">
                Permit Status: {{ p.Status }}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {% if mep_permits %}
          <div class="permit-group">
            <div class="permit-group-header">MEP & Other ({{ mep_permits | length }})</div>
            {% for p in mep_permits %}
            <div class="permit-compact mep">
              <div class="permit-compact-main">
                <span class="permit-compact-type">{{ p.permit_type }}</span>
                <span class="permit-compact-number">
                  {% if p.permit_number %}
                  <a href="https://ladbsdoc.lacity.org/IDISPublic_v2/idis/permitstatus.aspx?permit={{ p.permit_number|replace('/', '') }}" target="_blank" rel="noopener">
                    {{ p.permit_number }}
                  </a>
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>
              {% if p.Status %}
              <div class="permit-status {% if 'FINAL' in p.Status.upper() or 'COMPLETE' in p.Status.upper() %}completed{% elif 'ISSUED' in p.Status.upper() or 'PENDING' in p.Status.upper() %}pending{% elif 'EXPIRED' in p.Status.upper() %}expired{% endif %}">
                Permit Status: {{ p.Status }}
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% else %}
          <div class="no-data-message">
            {% if r.ladbs and r.ladbs.source and (r.ladbs.source.startswith('ladbs_stub_') or r.ladbs.source == 'ladbs_error') %}
              ⚠️ LADBS data unavailable - cannot verify permit history
            {% else %}
              No permits found for this property
            {% endif %}
          </div>
          {% endif %}

        </section>

      </article>
      {% endfor %}
    </section>
    {% endif %}

    <footer class="footer">
      <div>© {{ year or 2025 }} BLDGBIT · Internal Tool</div>
      <div class="footer-tagline">Efficient. Transparent. Investor-exclusive.</div>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // Form submit handler with progress bar
  document.getElementById("compForm").addEventListener("submit", () => {
    document.getElementById("loadingOverlay").classList.add("show");
    document.getElementById("progressBar").classList.add("active");
  });

  // Hide loading overlay when page fully loads
  window.addEventListener("load", () => {
    document.getElementById("loadingOverlay").classList.remove("show");
    document.getElementById("progressBar").classList.remove("active");
  });

  // Floating summary bar on scroll
  window.addEventListener("DOMContentLoaded", () => {
    const floatingSummary = document.getElementById("floatingSummary");
    const floatingSummaryText = document.getElementById("floatingSummaryText");
    const firstCompCard = document.querySelector(".comp-card");
    
    if (firstCompCard) {
      const address = firstCompCard.getAttribute("data-address") || "";
      const summary = firstCompCard.getAttribute("data-summary") || "";
      floatingSummaryText.textContent = address + (summary ? " · " + summary : "");
      
      window.addEventListener("scroll", () => {
        const cardRect = firstCompCard.getBoundingClientRect();
        if (cardRect.top < -100) {
          floatingSummary.classList.add("visible");
        } else {
          floatingSummary.classList.remove("visible");
        }
      });
    }

    // Initialize permit summary charts
    document.querySelectorAll("[id^='permitChart']").forEach(canvas => {
      const building = parseInt(canvas.dataset.building) || 0;
      const demo = parseInt(canvas.dataset.demo) || 0;
      const mep = parseInt(canvas.dataset.mep) || 0;
      
      if (building + demo + mep === 0) {
        canvas.parentElement.style.display = 'none';
        return;
      }

      new Chart(canvas, {
        type: "doughnut",
        data: {
          labels: ["Building/Alter", "Demolition", "MEP/Other"],
          datasets: [{
            data: [building, demo, mep],
            backgroundColor: ["#000", "#555", "#999"],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 12,
                padding: 16,
                font: { size: 12, family: 'Inter' }
              }
            }
          }
        }
      });
    });

    // Price history charts (existing)
    document.querySelectorAll("[data-price-history]").forEach(c => {
      const data = JSON.parse(c.dataset.priceHistory);

      new Chart(c, {
        type: "line",
        data: {
          labels: data.map(x => x.date),
          datasets: [{
            label: "Price",
            data: data.map(x => x.price),
            tension: 0.25,
            borderWidth: 2,
            borderColor: '#333',
            backgroundColor: 'rgba(0, 0, 0, 0.05)',
            pointBackgroundColor: data.map(x => 
              x.event === 'sold' ? '#000' : '#666'
            ),
            pointRadius: 4
          }]
        },
        options: { 
          plugins:{legend:{display:false}},
          scales: {
            y: {
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    });

    // Permit timeline charts (existing)
    document.querySelectorAll("[data-permit-timeline]").forEach(c => {
      const raw = JSON.parse(c.dataset.permitTimeline);
      
      // FILTER: only include permits with duration_days > 0
      const withDuration = raw.filter(x => x.duration_days && x.duration_days > 0);
      
      if (withDuration.length === 0) {
        c.style.display = 'none';  // hide chart if no data
        return;
      }
      
      const labels = withDuration.map(x => x.permit_number);
      const days = withDuration.map(x => x.duration_days);

      new Chart(c, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label:"Duration (days)",
            data:days,
            backgroundColor: '#333',
            borderWidth:1
          }]
        },
        options: { 
          indexAxis: 'y', 
          plugins:{legend:{display:false}},
          scales: {
            x: {
              title: { display: true, text: 'Days' }
            }
          }
        }
      });
    });
  });

  // Print / PDF download
  function printReport() {
    window.print();
  }
  </script>

</body>
</html>
