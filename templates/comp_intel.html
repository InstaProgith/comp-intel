<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BLDGBIT AI · Comp Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/comp.css') }}">
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing…</div>
  </div>

  <div class="bg-layer"></div>

  <main class="shell">

    <header class="hero-card">
      <div class="logo-wrap">
        <div class="logo-plate"></div>
        <img src="{{ url_for('static', filename='LG.png') }}"
             class="logo-img" alt="BLDGBIT">
      </div>
      <div class="hero-text">
        <div class="eyebrow">BLDGBIT AI</div>
        <h1 class="hero-title">Comp Intelligence</h1>
        <p class="hero-subtitle">
          Investor-grade comp briefs backed by LADBS intelligence.
        </p>
      </div>
    </header>

    <section class="panel">
      <form method="post" action="{{ url_for('comp_intel') }}" class="comp-form" id="compForm">
        <label class="field-label" for="urls">Paste Redfin URLs</label>
        <p class="field-hint">
          One per line. Example:
          <span class="hint-url">https://www.redfin.com/...</span>
        </p>

        <div class="textarea-wrap">
          <textarea id="urls" name="urls" rows="6">{{ urls_text or "" }}</textarea>
        </div>

        <div class="form-footer">
          <div class="foot-note">LADBS Auto Search Enabled</div>
          <button type="submit" class="btn-primary">
            <span>Run Analysis</span>
            <span class="btn-tag">AI</span>
          </button>
        </div>
      </form>
    </section>

    {% if results %}
    <section class="results">

      {% for r in results %}
      {% set ps = r.property_snapshot or {} %}
      {% set m = r.metrics or {} %}
      {% set cs = r.construction_summary or {} %}
      {% set cm = r.cost_model or {} %}
      {% set ts = r.timeline_summary or {} %}
      {% set pc = r.permit_categories or {} %}
      {% set team = r.team_network or {} %}
      {% set permits = r.ladbs.permits if r.ladbs and r.ladbs.permits else [] %}
      {% set dn = r.data_notes or [] %}
      {% set links = r.links or {} %}

      <article class="comp-card">
        
        <!-- 1. PROPERTY SNAPSHOT -->
        <header class="comp-header" style="padding:28px;">
          <div class="property-address" style="font-size:22px; font-weight:800; color:#111; letter-spacing:-0.5px; margin-bottom:8px;">
            {{ ps.address_full or r.address or "Unknown address" }}
          </div>
          <div style="font-size:14px; color:#555; margin-bottom:6px;">
            {% if ps.beds %}{{ ps.beds|int }} bd{% endif %}
            {% if ps.baths %} / {{ ps.baths }} ba{% endif %}
            {% if ps.building_sf %} · {{ "{:,.0f}".format(ps.building_sf) }} SF{% endif %}
            {% if ps.lot_sf %} · Lot {{ "{:,.0f}".format(ps.lot_sf) }} SF{% else %} · Lot: Unknown (no lot size found){% endif %}
            {% if ps.property_type %} · {{ ps.property_type }}{% endif %}
          </div>
          <div style="font-size:13px; color:#666;">
            <strong>{{ ps.status or "Status unknown" }}</strong>
            {% if ps.status_price %} · ${{ "{:,.0f}".format(ps.status_price) }}{% endif %}
            {% if ps.status_date %} on {{ ps.status_date }}{% endif %}
          </div>
          <a href="{{ r.url }}" target="_blank" class="comp-link" style="display:block; margin-top:8px;">{{ r.url }}</a>
        </header>

        <section class="comp-body">

          <!-- 2. DEVELOPER SNAPSHOT -->
          <div class="deal-snapshot">
            <div class="section-header">
              <h3 class="section-title">Developer Snapshot</h3>
            </div>
            <table style="width:100%; border-collapse:collapse;">
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600; width:45%;">Purchase Price</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if m.purchase_price %}${{ "{:,.0f}".format(m.purchase_price) }}{% else %}<span class="muted" style="font-style:italic;">Unknown (no prior sale in Redfin history)</span>{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Exit / List Price</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if m.exit_price %}${{ "{:,.0f}".format(m.exit_price) }}{% elif m.list_price %}${{ "{:,.0f}".format(m.list_price) }} (list){% else %}<span class="muted">Unknown</span>{% endif %}
                </td>
              </tr>
              {% if m.purchase_price %}
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Hold Period</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if m.hold_days %}{{ m.hold_days }} days (~{{ r.hold_months or (m.hold_days / 30.44)|round(1) }} months){% else %}<span class="muted">Unknown</span>{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Gross Spread</td>
                <td style="padding:10px 0; font-size:13px; color:#059669; font-weight:600; text-align:right;">
                  {% if m.spread %}${{ "{:,.0f}".format(m.spread) }}{% else %}<span class="muted" style="color:#999;">N/A</span>{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">ROI (simple)</td>
                <td style="padding:10px 0; font-size:13px; color:#059669; font-weight:600; text-align:right;">
                  {% if m.roi_pct %}{{ "{:.1f}%".format(m.roi_pct) }}{% else %}<span class="muted" style="color:#999;">N/A</span>{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Spread / Day</td>
                <td style="padding:10px 0; font-size:13px; color:#059669; font-weight:600; text-align:right;">
                  {% if m.spread_per_day %}${{ "{:,.0f}".format(m.spread_per_day) }}{% else %}<span class="muted" style="color:#999;">N/A</span>{% endif %}
                </td>
              </tr>
              {% endif %}
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Land SF</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if m.land_sf %}{{ "{:,.0f}".format(m.land_sf) }} SF{% else %}<span class="muted">Unknown</span>{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Existing SF</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if cs.existing_sf %}{{ "{:,.0f}".format(cs.existing_sf) }} SF{% else %}<span class="muted">Unknown</span>{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Added SF</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if cs.added_sf %}+{{ "{:,.0f}".format(cs.added_sf) }} SF{% else %}0{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Final SF</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if cs.final_sf %}{{ "{:,.0f}".format(cs.final_sf) }} SF{% else %}<span class="muted">Unknown</span>{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">FAR (before → after)</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if m.far_before %}{{ m.far_before }}{% else %}<span class="muted">N/A</span>{% endif %}
                  {% if m.far_after and m.far_after != m.far_before %} → {{ m.far_after }}{% endif %}
                </td>
              </tr>
              <tr>
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Scope Level</td>
                <td style="padding:10px 0; font-size:13px; text-align:right;">
                  <span class="scope-badge scope-{{ (pc.scope_level or 'unknown')|lower }}">{{ pc.scope_level or "UNKNOWN" }}</span>
                </td>
              </tr>
            </table>
          </div>
          
          <!-- 3. TIMELINE SUMMARY -->
          <div class="deal-snapshot">
            <div class="section-header">
              <h3 class="section-title">Timeline Summary</h3>
            </div>
            {% if ts.stages %}
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:10px 8px; background:#f5f5f5; color:#666; font-weight:700; font-size:10px; text-transform:uppercase;">Stage</th>
                  <th style="text-align:left; padding:10px 8px; background:#f5f5f5; color:#666; font-weight:700; font-size:10px; text-transform:uppercase;">Duration</th>
                  <th style="text-align:left; padding:10px 8px; background:#f5f5f5; color:#666; font-weight:700; font-size:10px; text-transform:uppercase;">Dates</th>
                </tr>
              </thead>
              <tbody>
                {% for stage in ts.stages %}
                <tr>
                  <td style="padding:10px 8px; border-bottom:1px solid #f0f0f0; color:#333;">{{ stage.name }}</td>
                  <td style="padding:10px 8px; border-bottom:1px solid #f0f0f0; color:#333;">{{ stage.days }} days</td>
                  <td style="padding:10px 8px; border-bottom:1px solid #f0f0f0; color:#333;">{{ stage.start_date }} → {{ stage.end_date }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% if ts.total_days %}
            <div style="margin-top:16px; font-size:14px; font-weight:700; color:#111;">
              Total Project Time: {{ ts.total_days }} days (~{{ ts.total_months }} months)
            </div>
            {% endif %}
            {% else %}
            <p class="muted" style="font-size:13px;">Timeline data unavailable. Missing purchase date or permit milestones.</p>
            {% endif %}
          </div>
          
          <!-- 4. CONSTRUCTION SUMMARY -->
          <div class="deal-snapshot">
            <div class="section-header">
              <h3 class="section-title">Construction Summary</h3>
            </div>
            <table style="width:100%; border-collapse:collapse;">
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600; width:45%;">Existing SF</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if cs.existing_sf %}{{ "{:,.0f}".format(cs.existing_sf) }} SF{% elif cs.is_new_construction %}<span class="muted" style="font-style:italic;">0 (New Construction)</span>{% else %}<span class="muted">Unknown</span>{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Added SF</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if cs.added_sf %}+{{ "{:,.0f}".format(cs.added_sf) }} SF{% else %}0{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Final SF</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if cs.final_sf %}{{ "{:,.0f}".format(cs.final_sf) }} SF{% else %}<span class="muted">Unknown</span>{% endif %}
                </td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Lot SF</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">
                  {% if cs.lot_sf %}{{ "{:,.0f}".format(cs.lot_sf) }} SF{% else %}<span class="muted">Unknown</span>{% endif %}
                </td>
              </tr>
              <tr>
                <td style="padding:10px 0; font-size:13px; color:#888; font-weight:600;">Scope Level</td>
                <td style="padding:10px 0; font-size:13px; text-align:right;">
                  <span class="scope-badge scope-{{ (cs.scope_level or 'unknown')|lower }}">{{ cs.scope_level or "UNKNOWN" }}</span>
                </td>
              </tr>
            </table>
          </div>
          
          <!-- 5. COST MODEL -->
          <div class="deal-snapshot">
            <div class="section-header">
              <h3 class="section-title">Cost Model</h3>
            </div>
            <table style="width:100%; border-collapse:collapse;">
              {% if cm.remodel_sf and cm.remodel_sf > 0 %}
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#555;">Remodel ({{ "{:,.0f}".format(cm.remodel_sf) }} SF × $150)</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">${{ "{:,.0f}".format(cm.cost_remodel) }}</td>
              </tr>
              {% endif %}
              {% if cm.addition_sf and cm.addition_sf > 0 %}
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#555;">Addition ({{ "{:,.0f}".format(cm.addition_sf) }} SF × $300)</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">${{ "{:,.0f}".format(cm.cost_addition) }}</td>
              </tr>
              {% endif %}
              {% if cm.new_sf_full and cm.new_sf_full > 0 %}
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#555;">New Construction ({{ "{:,.0f}".format(cm.new_sf_full) }} SF × $350)</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">${{ "{:,.0f}".format(cm.cost_new_construction) }}</td>
              </tr>
              {% endif %}
              {% if cm.garage_sf and cm.garage_sf > 0 %}
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#555;">Garage ({{ "{:,.0f}".format(cm.garage_sf) }} SF × $200)</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">${{ "{:,.0f}".format(cm.cost_garage) }}</td>
              </tr>
              {% endif %}
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#555;">Landscape / Hardscape / Demo</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">${{ "{:,.0f}".format(cm.cost_landscape) }}</td>
              </tr>
              {% if cm.has_pool %}
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#555;">Pool</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">${{ "{:,.0f}".format(cm.cost_pool) }}</td>
              </tr>
              {% endif %}
              <tr style="border-bottom:1px solid #f0f0f0; background:#f9f9f9;">
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:700;">Hard Cost Total</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:700; text-align:right;">${{ "{:,.0f}".format(cm.hard_cost_total) }}</td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#555;">Soft Costs (6%)</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">${{ "{:,.0f}".format(cm.soft_costs) }}</td>
              </tr>
              <tr style="border-bottom:1px solid #f0f0f0;">
                <td style="padding:10px 0; font-size:13px; color:#555;">Financing Cost</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:600; text-align:right;">${{ "{:,.0f}".format(cm.financing_cost) }}</td>
              </tr>
              {% if cm.total_project_cost %}
              <tr style="border-bottom:1px solid #f0f0f0; background:#f5f5f5;">
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:700;">Total Project Cost</td>
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:700; text-align:right;">${{ "{:,.0f}".format(cm.total_project_cost) }}</td>
              </tr>
              {% endif %}
              {% if cm.estimated_profit is not none %}
              <tr style="background:#f5f5f5;">
                <td style="padding:10px 0; font-size:13px; color:#111; font-weight:700;">Estimated Profit</td>
                <td style="padding:10px 0; font-size:13px; font-weight:700; text-align:right; color:{% if cm.estimated_profit > 0 %}#059669{% else %}#dc2626{% endif %};">
                  ${{ "{:,.0f}".format(cm.estimated_profit) }}
                </td>
              </tr>
              {% endif %}
            </table>
          </div>
          
          <!-- 6. PERMIT OVERVIEW -->
          <div class="deal-snapshot">
            <div class="section-header">
              <h3 class="section-title">Permit Overview</h3>
            </div>
            <div class="permit-summary-line">
              <strong>Permits:</strong> Building ({{ pc.building_count or 0 }}), Demolition ({{ pc.demo_count or 0 }}), MEP ({{ pc.mep_count or 0 }}), Other ({{ pc.other_count or 0 }})
              · <span class="scope-badge scope-{{ (pc.scope_level or 'unknown')|lower }}">{{ pc.scope_level or "UNKNOWN" }}</span>
            </div>
            
            {% if permits %}
            {% set building_permits = permits | selectattr('permit_type', 'match', '.*Bldg.*|.*Building.*') | list %}
            {% set demo_permits = permits | selectattr('permit_type', 'match', '.*Demo.*') | list %}
            {% set mep_permits = permits | selectattr('permit_type', 'match', '.*Electrical.*|.*Plumbing.*|.*Mechanical.*') | list %}
            {% set other_permits = permits | rejectattr('permit_type', 'match', '.*Bldg.*|.*Building.*|.*Demo.*|.*Electrical.*|.*Plumbing.*|.*Mechanical.*') | list %}

            {% if building_permits %}
            <div class="permit-group">
              <div class="permit-group-header">Building Permits ({{ building_permits | length }})</div>
              {% for p in building_permits %}
              <div class="permit-compact">
                <div class="permit-compact-main">
                  <span class="permit-compact-type">{{ p.permit_type }}</span>
                  <span class="permit-compact-number">{{ p.permit_number }}</span>
                </div>
                {% if p.Work_Description and p.Work_Description != 'N/A' %}
                <div class="permit-work-desc">{{ p.Work_Description }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% endif %}

            {% if demo_permits %}
            <div class="permit-group">
              <div class="permit-group-header">Demolition ({{ demo_permits | length }})</div>
              {% for p in demo_permits %}
              <div class="permit-compact">
                <div class="permit-compact-main">
                  <span class="permit-compact-type">{{ p.permit_type }}</span>
                  <span class="permit-compact-number">{{ p.permit_number }}</span>
                </div>
                {% if p.Work_Description and p.Work_Description != 'N/A' %}
                <div class="permit-work-desc">{{ p.Work_Description }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% endif %}

            {% if mep_permits %}
            <div class="permit-group">
              <div class="permit-group-header">MEP ({{ mep_permits | length }})</div>
              {% for p in mep_permits %}
              <div class="permit-compact">
                <div class="permit-compact-main">
                  <span class="permit-compact-type">{{ p.permit_type }}</span>
                  <span class="permit-compact-number">{{ p.permit_number }}</span>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            {% if other_permits %}
            <div class="permit-group">
              <div class="permit-group-header">Other ({{ other_permits | length }})</div>
              {% for p in other_permits %}
              <div class="permit-compact">
                <div class="permit-compact-main">
                  <span class="permit-compact-type">{{ p.permit_type }}</span>
                  <span class="permit-compact-number">{{ p.permit_number }}</span>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}
            {% else %}
            <p class="muted" style="font-size:13px; padding:12px 0;">No permits found for this property.</p>
            {% endif %}
          </div>
          
          <!-- 7. TEAM -->
          <div class="deal-snapshot">
            <div class="section-header">
              <h3 class="section-title">Team</h3>
            </div>
            {% if team.primary_gc %}
            <div class="snapshot-row" style="padding:12px 0; border-bottom:1px solid #f0f0f0;">
              <div class="snapshot-item-wide" style="flex-direction:column; gap:4px;">
                <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:#888;">GC</div>
                <div style="font-size:14px; font-weight:600; color:#111;">
                  {{ team.primary_gc.name }}
                  {% if team.primary_gc.license %}
                  <span class="team-license">Lic #{{ team.primary_gc.license }}</span>
                  {% endif %}
                  {% if team.primary_gc.cslb_url %}
                  <a href="{{ team.primary_gc.cslb_url }}" target="_blank" class="team-cslb-link">CSLB Profile →</a>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            
            {% if team.primary_architect %}
            <div class="snapshot-row" style="padding:12px 0; border-bottom:1px solid #f0f0f0;">
              <div class="snapshot-item-wide" style="flex-direction:column; gap:4px;">
                <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:#888;">Architect</div>
                <div style="font-size:14px; font-weight:600; color:#111;">
                  {{ team.primary_architect.name }}
                  {% if team.primary_architect.license %}
                  <span class="team-license">#{{ team.primary_architect.license }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            
            {% if team.primary_engineer %}
            <div class="snapshot-row" style="padding:12px 0;">
              <div class="snapshot-item-wide" style="flex-direction:column; gap:4px;">
                <div style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:#888;">Engineer</div>
                <div style="font-size:14px; font-weight:600; color:#111;">
                  {{ team.primary_engineer.name }}
                  {% if team.primary_engineer.license %}
                  <span class="team-license">#{{ team.primary_engineer.license }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
            
            {% if not team.primary_gc and not team.primary_architect and not team.primary_engineer %}
            <p class="muted" style="font-size:13px; padding:12px 0;">No team members found in permit records.</p>
            {% endif %}
          </div>
          
          <!-- 8. DATA NOTES -->
          <div class="deal-snapshot">
            <div class="section-header">
              <h3 class="section-title">Data Notes</h3>
            </div>
            {% if dn %}
            <ul style="list-style:none; padding:0; margin:0;">
              {% for note in dn %}
              <li style="padding:8px 0 8px 20px; position:relative; font-size:13px; color:#666; border-bottom:1px solid #f5f5f5;">
                <span style="position:absolute; left:0; color:#ccc;">•</span>
                {{ note }}
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p style="font-size:13px; color:#888; font-style:italic;">No major data issues detected.</p>
            {% endif %}
          </div>
          
          <!-- 9. LINKS -->
          <div class="deal-snapshot">
            <div class="section-header">
              <h3 class="section-title">Links</h3>
            </div>
            <div style="display:flex; flex-direction:column; gap:10px;">
              {% if links.redfin_url %}
              <div style="display:flex; align-items:center; gap:12px;">
                <span style="font-size:12px; color:#888; min-width:100px;">Redfin Listing</span>
                <a href="{{ links.redfin_url }}" target="_blank" style="font-size:13px; color:#111; text-decoration:none;">{{ links.redfin_url[:60] }}{% if links.redfin_url|length > 60 %}...{% endif %}</a>
              </div>
              {% endif %}
              
              {% if links.ladbs_url %}
              <div style="display:flex; align-items:center; gap:12px;">
                <span style="font-size:12px; color:#888; min-width:100px;">LADBS Permits</span>
                <a href="{{ links.ladbs_url }}" target="_blank" style="font-size:13px; color:#111; text-decoration:none;">LADBS Permit Search</a>
              </div>
              {% endif %}
              
              {% if links.gc_cslb_url %}
              <div style="display:flex; align-items:center; gap:12px;">
                <span style="font-size:12px; color:#888; min-width:100px;">CSLB Profile</span>
                <a href="{{ links.gc_cslb_url }}" target="_blank" style="font-size:13px; color:#111; text-decoration:none;">View GC License</a>
              </div>
              {% endif %}
            </div>
          </div>

        </section>

      </article>
      {% endfor %}
    </section>
    {% endif %}

    <!-- SEARCH HISTORY / LOG SECTION -->
    {% if search_log %}
    <section class="history-section panel">
      <div class="section-header">
        <h3 class="section-title">Search History</h3>
        <span class="section-count">{{ search_log | length }} comps logged</span>
      </div>
      
      <div class="history-table-wrap">
        <table class="history-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Address</th>
              <th>Purchase</th>
              <th>Exit/List</th>
              <th>Spread</th>
              <th>ROI</th>
              <th>Hold</th>
              <th>Scope</th>
              <th>Primary GC</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in search_log | reverse %}
            <tr>
              <td class="history-timestamp">{{ entry.timestamp[:16] if entry.timestamp else "—" }}</td>
              <td class="history-address">{{ entry.address[:30] if entry.address else "—" }}{% if entry.address and entry.address|length > 30 %}...{% endif %}</td>
              <td>{% if entry.purchase_price %}${{ "{:,.0f}".format(entry.purchase_price) }}{% else %}—{% endif %}</td>
              <td>{% if entry.exit_price %}${{ "{:,.0f}".format(entry.exit_price) }}{% else %}—{% endif %}</td>
              <td class="{% if entry.spread and entry.spread > 0 %}history-positive{% endif %}">{% if entry.spread %}${{ "{:,.0f}".format(entry.spread) }}{% else %}—{% endif %}</td>
              <td class="{% if entry.roi_pct and entry.roi_pct > 0 %}history-positive{% endif %}">{% if entry.roi_pct %}{{ "{:.1f}%".format(entry.roi_pct) }}{% else %}—{% endif %}</td>
              <td>{% if entry.hold_days %}{{ entry.hold_days }}d{% else %}—{% endif %}</td>
              <td><span class="scope-badge-sm scope-{{ (entry.scope_level or 'unknown')|lower }}">{{ entry.scope_level or "?" }}</span></td>
              <td class="history-gc">{{ (entry.primary_gc_name or "—")[:20] }}{% if entry.primary_gc_name and entry.primary_gc_name|length > 20 %}...{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endif %}
    
    <!-- REPEAT PLAYERS SECTION -->
    {% if repeat_players and (repeat_players.top_gcs or repeat_players.top_architects or repeat_players.top_engineers) %}
    <section class="repeat-players-section panel">
      <div class="section-header">
        <h3 class="section-title">Repeat Players</h3>
      </div>
      
      <div class="repeat-players-grid">
        {% if repeat_players.top_gcs %}
        <div class="repeat-player-group">
          <h4>Top GCs</h4>
          <ul class="repeat-player-list">
            {% for gc in repeat_players.top_gcs[:5] %}
            <li>
              <strong>{{ gc.name }}</strong> <span class="repeat-count">({{ gc.count }} comps)</span>
              <div class="repeat-addresses muted">{{ gc.addresses | join(", ") | truncate(60) }}</div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if repeat_players.top_architects %}
        <div class="repeat-player-group">
          <h4>Top Architects</h4>
          <ul class="repeat-player-list">
            {% for arch in repeat_players.top_architects[:5] %}
            <li>
              <strong>{{ arch.name }}</strong> <span class="repeat-count">({{ arch.count }} comps)</span>
              <div class="repeat-addresses muted">{{ arch.addresses | join(", ") | truncate(60) }}</div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if repeat_players.top_engineers %}
        <div class="repeat-player-group">
          <h4>Top Engineers</h4>
          <ul class="repeat-player-list">
            {% for eng in repeat_players.top_engineers[:5] %}
            <li>
              <strong>{{ eng.name }}</strong> <span class="repeat-count">({{ eng.count }} comps)</span>
              <div class="repeat-addresses muted">{{ eng.addresses | join(", ") | truncate(60) }}</div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </section>
    {% endif %}

    <footer class="footer">
      <div>© {{ year or 2025 }} BLDGBIT · Internal Tool</div>
      <div class="footer-tagline">Efficient. Transparent. Investor-exclusive.</div>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  document.getElementById("compForm").addEventListener("submit", () => {
    document.getElementById("loadingOverlay").classList.add("show");
  });

  // Hide loading overlay when page fully loads
  window.addEventListener("load", () => {
    document.getElementById("loadingOverlay").classList.remove("show");
  });

  // Debug toggle function
  function toggleDebug(id) {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
  }
  
  // Debug tab switching
  function switchDebugTab(containerId, tabName) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Hide all panels
    container.querySelectorAll('.debug-panel').forEach(p => p.style.display = 'none');
    // Show selected panel
    container.querySelector('[data-tab="' + tabName + '"]').style.display = 'block';
    
    // Update tab buttons
    container.querySelectorAll('.debug-tab').forEach(t => t.classList.remove('active'));
    // Get the clicked button from window.event for cross-browser support
    if (window.event && window.event.target) {
      window.event.target.classList.add('active');
    }
  }

  window.addEventListener("DOMContentLoaded", () => {

    document.querySelectorAll("[data-price-history]").forEach(c => {
      const data = JSON.parse(c.dataset.priceHistory);

      new Chart(c, {
        type: "line",
        data: {
          labels: data.map(x => x.date),
          datasets: [{
            label: "Price",
            data: data.map(x => x.price),
            tension: 0.25,
            borderWidth: 2,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            pointBackgroundColor: data.map(x => 
              x.event === 'sold' ? '#ef4444' : '#3b82f6'
            ),
            pointRadius: 4
          }]
        },
        options: { 
          plugins:{legend:{display:false}},
          scales: {
            y: {
              ticks: {
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    });

    document.querySelectorAll("[data-permit-timeline]").forEach(c => {
      const raw = JSON.parse(c.dataset.permitTimeline);
      
      // FILTER: only include permits with duration_days > 0
      const withDuration = raw.filter(x => x.duration_days && x.duration_days > 0);
      
      if (withDuration.length === 0) {
        c.style.display = 'none';  // hide chart if no data
        return;
      }
      
      const labels = withDuration.map(x => x.permit_number);
      const days = withDuration.map(x => x.duration_days);

      new Chart(c, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label:"Duration (days)",
            data:days,
            backgroundColor: '#3b82f6',
            borderWidth:1
          }]
        },
        options: { 
          indexAxis: 'y', 
          plugins:{legend:{display:false}},
          scales: {
            x: {
              title: { display: true, text: 'Days' }
            }
          }
        }
      });
    });
  });
  </script>

</body>
</html>
