<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BLDGBIT AI · Comp Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/comp.css') }}">
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Analyzing…</div>
  </div>

  <div class="bg-layer"></div>

  <main class="shell">

    <header class="hero-card">
      <div class="logo-wrap">
        <div class="logo-plate"></div>
        <img src="{{ url_for('static', filename='LG.png') }}"
             class="logo-img" alt="BLDGBIT">
      </div>
      <div class="hero-text">
        <div class="eyebrow">BLDGBIT AI</div>
        <h1 class="hero-title">Comp Intelligence</h1>
        <p class="hero-subtitle">
          Investor-grade comp briefs backed by LADBS intelligence.
        </p>
      </div>
    </header>

    <section class="panel">
      <form method="post" action="{{ url_for('comp_intel') }}" class="comp-form" id="compForm">
        <label class="field-label" for="urls">Paste Redfin URLs</label>
        <p class="field-hint">
          One per line. Example:
          <span class="hint-url">https://www.redfin.com/...</span>
        </p>

        <div class="textarea-wrap">
          <textarea id="urls" name="urls" rows="6">{{ urls_text or "" }}</textarea>
        </div>

        <div class="form-footer">
          <div class="foot-note">LADBS Auto Search Enabled</div>
          <button type="submit" class="btn-primary">
            <span>Run Analysis</span>
            <span class="btn-tag">AI</span>
          </button>
        </div>
      </form>
    </section>

    {% if results %}
    <section class="results">

      {% for r in results %}
      {% set ps = r.property_snapshot or {} %}
      {% set metrics = r.metrics or {} %}
      {% set pt = r.permit_timeline or {} %}
      {% set pd = r.project_durations or {} %}
      {% set cs = r.construction_summary or {} %}
      {% set cm = r.cost_model or {} %}
      {% set po = r.permit_overview or {} %}
      {% set ti = r.team_info or {} %}
      {% set dn = r.data_notes or [] %}
      {% set links = r.links or {} %}

      <article class="comp-card report-card">

        <!-- ============================================================ -->
        <!-- SECTION 1: PROPERTY SNAPSHOT -->
        <!-- ============================================================ -->
        <header class="property-header">
          <div class="property-address">{{ ps.address_full or r.address or "Unknown address" }}</div>
          <div class="property-details">
            {% if ps.beds %}{{ ps.beds|int }} bd{% endif %}
            {% if ps.baths %} / {{ ps.baths }} ba{% endif %}
            {% if ps.building_sf %} · {{ "{:,.0f}".format(ps.building_sf) }} SF{% endif %}
            {% if ps.lot_sf %} · Lot {{ "{:,.0f}".format(ps.lot_sf) }} SF{% else %} · Lot: Unknown (no lot size found){% endif %}
            {% if ps.property_type %} · {{ ps.property_type }}{% endif %}
          </div>
          <div class="property-status">
            {{ ps.status or "Unknown" }}
            {% if ps.status_price %} · ${{ "{:,.0f}".format(ps.status_price) }}{% endif %}
            {% if ps.status_date %} on {{ ps.status_date }}{% endif %}
          </div>
        </header>

        <section class="comp-body">

          <!-- ============================================================ -->
          <!-- SECTION 2: DEVELOPER SNAPSHOT -->
          <!-- ============================================================ -->
          <div class="report-section">
            <div class="section-header">
              <h3 class="section-title">Developer Snapshot</h3>
            </div>
            
            <div class="metrics-table">
              <div class="metrics-row">
                <span class="metrics-label">Purchase Price</span>
                <span class="metrics-value">
                  {% if metrics.purchase_price %}
                    ${{ "{:,.0f}".format(metrics.purchase_price) }}
                    {% if metrics.purchase_date %}<span class="metrics-date">{{ metrics.purchase_date }}</span>{% endif %}
                  {% else %}
                    <span class="muted">Unknown (no prior sale in Redfin history)</span>
                  {% endif %}
                </span>
              </div>
              
              <div class="metrics-row">
                <span class="metrics-label">Exit / List Price</span>
                <span class="metrics-value">
                  {% if metrics.exit_price %}
                    ${{ "{:,.0f}".format(metrics.exit_price) }}
                    {% if metrics.exit_date %}<span class="metrics-date">{{ metrics.exit_date }}</span>{% endif %}
                  {% elif metrics.list_price %}
                    ${{ "{:,.0f}".format(metrics.list_price) }} <span class="muted">(current listing)</span>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </span>
              </div>
              
              <div class="metrics-row">
                <span class="metrics-label">Hold Period</span>
                <span class="metrics-value">
                  {% if metrics.hold_days %}
                    {{ metrics.hold_days }} days (~{{ (metrics.hold_days / 30)|round|int }} months)
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </span>
              </div>
              
              {% if metrics.purchase_price and (metrics.exit_price or metrics.list_price) %}
              <div class="metrics-row">
                <span class="metrics-label">Gross Spread</span>
                <span class="metrics-value {% if metrics.spread and metrics.spread > 0 %}metrics-positive{% endif %}">
                  {% if metrics.spread %}${{ "{:,.0f}".format(metrics.spread) }}{% else %}<span class="muted">—</span>{% endif %}
                </span>
              </div>
              
              <div class="metrics-row">
                <span class="metrics-label">ROI (Simple)</span>
                <span class="metrics-value {% if metrics.roi_pct and metrics.roi_pct > 0 %}metrics-positive{% endif %}">
                  {% if metrics.roi_pct %}{{ "{:.1f}%".format(metrics.roi_pct) }}{% else %}<span class="muted">—</span>{% endif %}
                </span>
              </div>
              
              <div class="metrics-row">
                <span class="metrics-label">Spread / Day</span>
                <span class="metrics-value">
                  {% if metrics.spread_per_day %}${{ "{:,.0f}".format(metrics.spread_per_day) }}{% else %}<span class="muted">—</span>{% endif %}
                </span>
              </div>
              {% endif %}
              
              <div class="metrics-row">
                <span class="metrics-label">Land SF</span>
                <span class="metrics-value">
                  {% if metrics.lot_sf %}{{ "{:,.0f}".format(metrics.lot_sf) }} SF{% else %}<span class="muted">Unknown</span>{% endif %}
                </span>
              </div>
              
              <div class="metrics-row">
                <span class="metrics-label">Existing SF</span>
                <span class="metrics-value">
                  {% if metrics.original_sf %}{{ "{:,.0f}".format(metrics.original_sf) }} SF{% else %}<span class="muted">—</span>{% endif %}
                </span>
              </div>
              
              <div class="metrics-row">
                <span class="metrics-label">Added SF</span>
                <span class="metrics-value">
                  {% if cs.added_sf %}+{{ "{:,.0f}".format(cs.added_sf) }} SF{% else %}<span class="muted">0</span>{% endif %}
                </span>
              </div>
              
              <div class="metrics-row">
                <span class="metrics-label">Final SF</span>
                <span class="metrics-value">
                  {% if metrics.new_sf %}{{ "{:,.0f}".format(metrics.new_sf) }} SF{% else %}<span class="muted">—</span>{% endif %}
                </span>
              </div>
              
              <div class="metrics-row">
                <span class="metrics-label">FAR (before → after)</span>
                <span class="metrics-value">
                  {% if metrics.far_before or metrics.far_after %}
                    {{ metrics.far_before or "—" }} → {{ metrics.far_after or "—" }}
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </span>
              </div>
              
              <div class="metrics-row">
                <span class="metrics-label">Scope Level</span>
                <span class="metrics-value scope-{{ cs.scope_level|lower if cs.scope_level else 'unknown' }}">
                  {{ cs.scope_level or "UNKNOWN" }}
                </span>
              </div>
            </div>
          </div>

          <!-- ============================================================ -->
          <!-- SECTION 3: TIMELINE SUMMARY -->
          <!-- ============================================================ -->
          <div class="report-section">
            <div class="section-header">
              <h3 class="section-title">Timeline Summary</h3>
            </div>
            
            <table class="timeline-table">
              <thead>
                <tr>
                  <th>Stage</th>
                  <th>Duration</th>
                  <th>Dates</th>
                </tr>
              </thead>
              <tbody>
                {% if metrics.purchase_date and pt.plans_submitted_date %}
                <tr>
                  <td>Purchase → Plans Submitted</td>
                  <td>{{ pd.days_to_submit or "—" }} days</td>
                  <td>{{ metrics.purchase_date }} → {{ pt.plans_submitted_date }}</td>
                </tr>
                {% endif %}
                
                {% if pt.plans_submitted_date and pt.plans_approved_date %}
                <tr>
                  <td>Plans Submitted → Approval</td>
                  <td>{{ pd.days_to_approve or "—" }} days</td>
                  <td>{{ pt.plans_submitted_date }} → {{ pt.plans_approved_date }}</td>
                </tr>
                {% endif %}
                
                {% if pt.plans_approved_date and pt.construction_completed_date %}
                <tr>
                  <td>Plans Approved → Construction Complete</td>
                  <td>{{ pd.days_to_complete or "—" }} days</td>
                  <td>{{ pt.plans_approved_date }} → {{ pt.construction_completed_date }}</td>
                </tr>
                {% endif %}
                
                {% if not (metrics.purchase_date and pt.plans_submitted_date) and not (pt.plans_submitted_date and pt.plans_approved_date) and not (pt.plans_approved_date and pt.construction_completed_date) %}
                <tr>
                  <td colspan="3" class="muted">Timeline data not available</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
            
            {% if pd.total_project_days %}
            <div class="timeline-total">
              <strong>Total Project Time:</strong> {{ pd.total_project_days }} days (~{{ (pd.total_project_days / 30)|round|int }} months)
            </div>
            {% elif metrics.hold_days %}
            <div class="timeline-total">
              <strong>Total Hold Period:</strong> {{ metrics.hold_days }} days (~{{ (metrics.hold_days / 30)|round|int }} months)
            </div>
            {% endif %}
          </div>

          <!-- ============================================================ -->
          <!-- SECTION 4: CONSTRUCTION SUMMARY -->
          <!-- ============================================================ -->
          <div class="report-section">
            <div class="section-header">
              <h3 class="section-title">Construction Summary</h3>
            </div>
            
            <div class="construction-grid">
              <div class="construction-item">
                <span class="construction-label">Existing SF</span>
                <span class="construction-value">
                  {% if cs.existing_sf %}{{ "{:,.0f}".format(cs.existing_sf) }}{% elif cs.is_new_construction %}0 (New Construction){% else %}—{% endif %}
                </span>
              </div>
              <div class="construction-item">
                <span class="construction-label">Added SF</span>
                <span class="construction-value">
                  {% if cs.added_sf %}+{{ "{:,.0f}".format(cs.added_sf) }}{% else %}0{% endif %}
                </span>
              </div>
              <div class="construction-item">
                <span class="construction-label">Final SF</span>
                <span class="construction-value">
                  {% if cs.final_sf %}{{ "{:,.0f}".format(cs.final_sf) }}{% else %}—{% endif %}
                </span>
              </div>
              <div class="construction-item">
                <span class="construction-label">Lot SF</span>
                <span class="construction-value">
                  {% if cs.lot_sf %}{{ "{:,.0f}".format(cs.lot_sf) }}{% else %}Unknown{% endif %}
                </span>
              </div>
              <div class="construction-item">
                <span class="construction-label">Scope Level</span>
                <span class="construction-value scope-{{ cs.scope_level|lower if cs.scope_level else 'unknown' }}">
                  {{ cs.scope_level or "UNKNOWN" }}
                </span>
              </div>
            </div>
          </div>

          <!-- ============================================================ -->
          <!-- SECTION 5: COST MODEL -->
          <!-- ============================================================ -->
          <div class="report-section">
            <div class="section-header">
              <h3 class="section-title">Cost Model</h3>
            </div>
            
            <div class="cost-table">
              {% if cm.cost_remodel and cm.cost_remodel > 0 %}
              <div class="cost-row">
                <span class="cost-label">Remodel ({{ cm.remodel_sf|int if cm.remodel_sf else 0 }} SF × $150)</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.cost_remodel) }}</span>
              </div>
              {% endif %}
              
              {% if cm.cost_addition and cm.cost_addition > 0 %}
              <div class="cost-row">
                <span class="cost-label">Addition ({{ cm.addition_sf|int if cm.addition_sf else 0 }} SF × $300)</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.cost_addition) }}</span>
              </div>
              {% endif %}
              
              {% if cm.cost_new_construction and cm.cost_new_construction > 0 %}
              <div class="cost-row">
                <span class="cost-label">New Construction ({{ cm.new_construction_sf|int if cm.new_construction_sf else 0 }} SF × $350)</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.cost_new_construction) }}</span>
              </div>
              {% endif %}
              
              {% if cm.cost_garage and cm.cost_garage > 0 %}
              <div class="cost-row">
                <span class="cost-label">Garage ({{ cm.garage_sf|int if cm.garage_sf else 0 }} SF × $200)</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.cost_garage) }}</span>
              </div>
              {% endif %}
              
              <div class="cost-row">
                <span class="cost-label">Landscape / Hardscape / Demo</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.cost_landscape or 30000) }}</span>
              </div>
              
              {% if cm.has_pool %}
              <div class="cost-row">
                <span class="cost-label">Pool</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.cost_pool or 70000) }}</span>
              </div>
              {% endif %}
              
              <div class="cost-row cost-subtotal">
                <span class="cost-label">Hard Cost Total</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.hard_cost_total or 0) }}</span>
              </div>
              
              <div class="cost-row">
                <span class="cost-label">Soft Costs (6%)</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.soft_costs or 0) }}</span>
              </div>
              
              <div class="cost-row">
                <span class="cost-label">Financing Cost</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.financing_cost or 0) }}</span>
              </div>
              
              {% if cm.purchase_price %}
              <div class="cost-row">
                <span class="cost-label">+ Purchase Price</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.purchase_price) }}</span>
              </div>
              {% endif %}
              
              <div class="cost-row cost-total">
                <span class="cost-label">Total Project Cost</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.total_project_cost or 0) }}</span>
              </div>
              
              {% if cm.estimated_profit is not none %}
              <div class="cost-row cost-profit {% if cm.estimated_profit > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                <span class="cost-label">Estimated Profit</span>
                <span class="cost-value">${{ "{:,.0f}".format(cm.estimated_profit) }}</span>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- ============================================================ -->
          <!-- SECTION 6: PERMIT OVERVIEW -->
          <!-- ============================================================ -->
          <div class="report-section">
            <div class="section-header">
              <h3 class="section-title">Permit Overview</h3>
            </div>
            
            <div class="permit-summary-bar">
              Permits: Building ({{ po.building_count or 0 }}), Demolition ({{ po.demo_count or 0 }}), MEP ({{ po.mep_count or 0 }}), Other ({{ po.other_count or 0 }}) · 
              <span class="scope-{{ cs.scope_level|lower if cs.scope_level else 'unknown' }}">Scope Level: {{ cs.scope_level or "UNKNOWN" }}</span>
            </div>
            
            {% if po.building_permits %}
            <div class="permit-group">
              <div class="permit-group-header">BUILDING PERMITS ({{ po.building_count }})</div>
              {% for p in po.building_permits %}
              <div class="permit-compact">
                <div class="permit-compact-main">
                  <span class="permit-compact-type">{{ p.permit_type or p.Type or "Building" }}</span>
                  <span class="permit-compact-number">{{ p.permit_number }}</span>
                </div>
                {% if p.Work_Description and p.Work_Description != 'N/A' %}
                <div class="permit-work-desc">{{ p.Work_Description }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% endif %}
            
            {% if po.demo_permits %}
            <div class="permit-group">
              <div class="permit-group-header">DEMOLITION ({{ po.demo_count }})</div>
              {% for p in po.demo_permits %}
              <div class="permit-compact">
                <div class="permit-compact-main">
                  <span class="permit-compact-type">{{ p.permit_type or p.Type or "Demo" }}</span>
                  <span class="permit-compact-number">{{ p.permit_number }}</span>
                </div>
                {% if p.Work_Description and p.Work_Description != 'N/A' %}
                <div class="permit-work-desc">{{ p.Work_Description }}</div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% endif %}
            
            {% if po.mep_permits %}
            <div class="permit-group">
              <div class="permit-group-header">MEP ({{ po.mep_count }})</div>
              {% for p in po.mep_permits %}
              <div class="permit-compact">
                <div class="permit-compact-main">
                  <span class="permit-compact-type">{{ p.permit_type or p.Type or "MEP" }}</span>
                  <span class="permit-compact-number">{{ p.permit_number }}</span>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}
            
            {% if po.other_permits %}
            <div class="permit-group">
              <div class="permit-group-header">OTHER ({{ po.other_count }})</div>
              {% for p in po.other_permits %}
              <div class="permit-compact">
                <div class="permit-compact-main">
                  <span class="permit-compact-type">{{ p.permit_type or p.Type or "Other" }}</span>
                  <span class="permit-compact-number">{{ p.permit_number }}</span>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}
            
            {% if po.total_permits == 0 %}
            <div class="no-data-message">
              No LADBS permits found for this property.
            </div>
            {% endif %}
          </div>

          <!-- ============================================================ -->
          <!-- SECTION 7: TEAM -->
          <!-- ============================================================ -->
          {% if ti.gc_name or ti.architect_name or ti.engineer_name %}
          <div class="report-section">
            <div class="section-header">
              <h3 class="section-title">Team</h3>
            </div>
            
            <div class="team-list">
              {% if ti.gc_name %}
              <div class="team-row">
                <span class="team-role">GC:</span>
                <span class="team-value">
                  {{ ti.gc_name }}
                  {% if ti.gc_license %}, Lic {{ ti.gc_license }}{% endif %}
                  {% if ti.gc_cslb_url %} <a href="{{ ti.gc_cslb_url }}" target="_blank" class="team-link">(CSLB)</a>{% endif %}
                </span>
              </div>
              {% endif %}
              
              {% if ti.architect_name %}
              <div class="team-row">
                <span class="team-role">Architect:</span>
                <span class="team-value">{{ ti.architect_name }}</span>
              </div>
              {% endif %}
              
              {% if ti.engineer_name %}
              <div class="team-row">
                <span class="team-role">Engineer:</span>
                <span class="team-value">{{ ti.engineer_name }}</span>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- ============================================================ -->
          <!-- SECTION 8: DATA NOTES -->
          <!-- ============================================================ -->
          {% if dn %}
          <div class="report-section">
            <div class="section-header">
              <h3 class="section-title">Data Notes</h3>
            </div>
            
            <ul class="data-notes-list">
              {% for note in dn %}
              <li>{{ note }}</li>
              {% endfor %}
            </ul>
          </div>
          {% else %}
          <div class="report-section">
            <div class="section-header">
              <h3 class="section-title">Data Notes</h3>
            </div>
            <p class="muted">No major data issues detected.</p>
          </div>
          {% endif %}

          <!-- ============================================================ -->
          <!-- SECTION 9: LINKS -->
          <!-- ============================================================ -->
          <div class="report-section">
            <div class="section-header">
              <h3 class="section-title">Links</h3>
            </div>
            
            <div class="links-list">
              {% if links.redfin_url %}
              <a href="{{ links.redfin_url }}" target="_blank" class="link-item">Redfin Listing</a>
              {% endif %}
              {% if links.ladbs_url %}
              <a href="{{ links.ladbs_url }}" target="_blank" class="link-item">LADBS Permits</a>
              {% endif %}
              {% if links.cslb_url %}
              <a href="{{ links.cslb_url }}" target="_blank" class="link-item">CSLB Profile</a>
              {% endif %}
            </div>
          </div>

        </section>

      </article>
      {% endfor %}
    </section>
    {% endif %}

    <footer class="footer">
      <div>© {{ year or 2025 }} BLDGBIT · Internal Tool</div>
      <div class="footer-tagline">Efficient. Transparent. Investor-exclusive.</div>
    </footer>
  </main>

  <script>
  document.getElementById("compForm").addEventListener("submit", () => {
    document.getElementById("loadingOverlay").classList.add("show");
  });

  // Hide loading overlay when page fully loads
  window.addEventListener("load", () => {
    document.getElementById("loadingOverlay").classList.remove("show");
  });
  </script>

</body>
</html>
